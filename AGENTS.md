# AGENTS.md — Operational Playbook

How AI agents work in this repository.

## Codebase Navigation

Every directory contains a `.glance.md` — a pre-computed summary of that directory's purpose, architecture, key files, dependencies, and gotchas. Generated by the `/cartographer` skill.

**Use them before reading files.** When entering an unfamiliar directory:

```
1. Read <dir>/.glance.md          — architecture, key files, constraints
2. Then read specific files        — only what the task requires
```

This saves tokens and orients you faster than `ls` + reading everything.

`.glance.md` files cover: purpose, architecture patterns, key file roles, subdirectory summaries, important dependencies, and technical gotchas.

When you make significant structural changes to a directory, regenerate its `.glance.md` with `/cartographer`.

## Commit Conventions

Conventional Commits enforced by commitlint (git hook + CI).

**Format:** `type(scope): description` — imperative mood, ≤100 chars

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`

**Scopes:** Module name — `books`, `notes`, `import`, `stt`, `stripe`, `auth`, `observability`, `tracking`, `landing`, `security`, `ci`, `deps`

**Release impact:** `feat` → minor, `fix`/`perf`/`refactor` → patch, others → no release

**Examples:**
```
feat(import): add Goodreads CSV parser with field mapping
fix(stripe): handle past-due grace period edge case
test(convex): add listening session state machine coverage
chore(deps): bump production dependencies
```

## Testing Guidelines

**Framework:** Vitest (unit/integration), Playwright (E2E)

**Location conventions:**
- Convex backend tests: `__tests__/convex/`
- API route tests: `__tests__/api/` or colocated `__tests__/route.test.ts`
- Component tests: colocated `__tests__/Component.test.tsx`
- Import system tests: `__tests__/import/`
- Listening session tests: `__tests__/listening-sessions/`
- E2E tests: `e2e/`
- Lib tests: `lib/**/__tests__/` or colocated `.test.ts`

**Patterns:**
- AAA structure (Arrange, Act, Assert)
- One behavior per test
- Name: `should [behavior] when [condition]`
- Mock external services (Clerk, Stripe, Convex client), not domain logic
- Test behavior not implementation

**Coverage targets:** Critical paths (auth, privacy, payments, data integrity) at 75%. Don't test shadcn components.

**Running:**
```bash
bun run test              # All tests
bun run test:coverage     # With coverage report
bun run e2e               # Playwright E2E
bun run session-guardrails # Listening session cost checks
```

## PR Guidelines

**Required sections in PR description:**

1. **Summary** — What changed and why. Link the issue.
2. **Changes** — Concise list of what was done. Key files/functions.
3. **Acceptance Criteria** — From issue or derived. Checkboxes.
4. **Manual QA** — Step-by-step: commands, URLs, expected output.
5. **Test Coverage** — Specific test files. Note gaps and why.

**Process:**
- Branch from `master`, PR back to `master`
- CI must pass: lint, typecheck, test:coverage, trufflehog, build, e2e
- Keep diffs focused — split feature work from refactors
- Semantic-release auto-versions on merge

## Coding Style

**TypeScript strict mode.** No `any` unless documented with TODO.

**File naming:**
- Components/providers/hooks: PascalCase (`BookGrid.tsx`, `useUploadCover.ts`)
- Utility modules: kebab-case (`lib/markdown.ts`)
- Test files: `*.test.ts` / `*.test.tsx`

**Patterns:**
- Early returns over nested conditionals
- Deep modules — simple interfaces hiding complex implementation
- Tailwind classes inline; extract with `class-variance-authority` when props multiply
- Convex: queries for reads, mutations for writes, actions for external calls
- API routes: wrap with `withObservability()` for automatic error capture

**Forbidden names:** Manager, Helper, Util, Misc, Common

## Security Boundaries

Agents must NEVER without human approval:
- Modify auth logic (`convex/auth.ts`, `proxy.ts`)
- Change privacy model (book privacy, profile visibility)
- Alter payment/subscription logic (`convex/subscriptions.ts`, Stripe webhook handler)
- Lower quality gates (coverage thresholds, lint rules, type strictness)
- Expose API keys or secrets (even in tests — use mocks)
- Skip webhook signature verification
- Modify rate limiting rules (`convex/rateLimit.ts`)

## Definition of Done

An issue is complete when:
- [ ] Implementation matches acceptance criteria
- [ ] Tests pass (`bun run validate:fast` at minimum)
- [ ] No type errors (`bun run typecheck`)
- [ ] Ownership validation on any new mutations
- [ ] Error states handled (toast for user-facing, captureError for monitoring)
- [ ] Loading states present for async operations
- [ ] No secrets in code or test fixtures
- [ ] PR description has all 5 required sections

## Issue Workflow

**Labels:** `bug`, `feature`, `chore`, `docs`, `security`, `performance`

**Priority:** P0 (production down) → P1 (user-facing bug) → P2 (enhancement) → P3 (nice-to-have)

**Picking work:** P0/P1 first. Check for blocking dependencies. Read the full issue before starting.
