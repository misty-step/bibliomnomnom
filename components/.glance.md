The `/components` directory constitutes the modular frontend architecture of the application, organized into domain-specific modules that separate core business logic (books, notes, profiles) from structural infrastructure (layout, navigation, providers). The architecture follows a "Container-Presentational" pattern, leveraging **Convex** for real-time reactive data persistence, **Clerk** for identity management, and **Radix UI/shadcn** for accessible UI primitives.

### Purpose and Architecture

The directory is structured to support a high-interactivity library management system. Its primary purpose is to facilitate book ingestion, metadata management, and AI-driven synthesis of reading habits.

- **State Management:** Real-time synchronization is handled via Convex hooks (`useAuthedQuery`, `useMutation`), favoring optimistic updates for immediate UI feedback.
- **Design System:** Visual consistency is enforced through a centralized `ui/` layer and a custom design system utilizing **Tailwind CSS**, **Framer Motion** for layout transitions, and an "Editorial/Art Deco" aesthetic.
- **Data Ingestion & Portability:** Specialized modules (`import/` and `library/`) manage complex state machines for migrating data from external platforms (Goodreads/StoryGraph) and exporting collections in multiple formats (JSON, CSV, Markdown).

### Key File Roles

- **Core Entities (`book/`, `notes/`, `profile/`):**
  - `BookDetail.tsx` & `BookGrid.tsx`: Manage the lifecycle of book metadata and chronological visualization.
  - `NoteCard.tsx` & `Editor.tsx`: A Tiptap-based rich text engine supporting Markdown-to-HTML conversion and OCR-driven quote capture.
  - `ProfilePage.tsx`: An orchestrator for the "Reader Identity" dashboard, integrating AI-generated insights and thematic clusters.
- **Capture Systems (`notes/`):**
  - `PhotoQuoteCapture.tsx`: Manages a client-side OCR pipeline with image transcoding.
  - `useListeningSessionRecorder.ts`: A complex state machine for audio capture, utilizing the `MediaRecorder` API and AI synthesis.
- **Infrastructure (`navigation/`, `layout/`, `providers/`):**
  - `LibraryNav.tsx`: A polymorphic navigation component with persistent "rail" states and manual keyboard focus management.
  - `PostHogProvider.tsx`: Orchestrates product analytics, synchronizing Clerk authentication states with PostHog identity.
  - `SubscriptionGate.tsx`: Enforces feature access via a trial-initiation and Stripe-synchronization layer.
- **UI Primitives (`ui/`, `shared/`):**
  - `Surface.tsx`: A polymorphic container abstraction managing elevation and depth.
  - `ErrorBoundary.tsx`: A functional safety wrapper to prevent application-wide crashes during component-level failures.

### Important Dependencies

- **Convex (`convex/react`)**: The backbone for all server-side state and reactive queries.
- **Framer Motion**: Powers layout animations and handles accessibility via `useReducedMotion`.
- **Tiptap & DOMPurify**: Used for the rich-text note-taking engine and safe Markdown rendering.
- **PostHog**: Integrated for session telemetry and event tracking across conversion funnels.
- **Vercel Blob**: Facilitates binary asset storage for custom book covers.

### Technical Gotchas

- **Hydration & SSR Boundaries:** Components interacting with `window` APIs (e.g., `ThemeToggle`, `LibraryNav` storage, and `SpeechRecognition`) implement `mounted` state checks to prevent hydration mismatches.
- **Image Optimization:** The system bypasses Next.js Image optimization for external URLs (Google Books/Open Library) that are not pre-configured, falling back to standard `<img>` tags to avoid runtime errors.
- **CORS & Transcoding:** External image sourcing in `BookCoverManager` and OCR processing in `PhotoQuoteCapture` utilize server-side actions and client-side transcoding to bypass CORS restrictions and payload limits.
- **Event Propagation:** Interactive elements within parent-navigable cards (like `BookTile` or `LibraryNav`) require strict `stopPropagation` to prevent conflicting navigation triggers.
- **Data Compatibility:** The `profile/` module includes normalization logic to maintain backward compatibility between legacy string-based AI outputs and newer structured schemas.
- **Button Defaults:** The base `Button.tsx` primitive defaults to `type="button"`, overriding the standard HTML `submit` behavior to prevent unintended form triggers.
