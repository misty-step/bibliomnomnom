### Technical Overview: /components/subscription

This directory implements the client-side subscription management and access control layer for the application. It manages the user lifecycle from trial initiation through payment synchronization and content gating.

#### Architecture and Purpose

The architecture follows a provider-consumer pattern where subscription state is fetched via Convex and enforced through higher-order layout components. The system is designed to handle four primary states: unsubscribed (new users), trialing, active, and expired/canceled. It integrates directly with Stripe for checkout reconciliation and uses a "gate" pattern to protect application features.

#### Key File Roles

- **`SubscriptionGate.tsx`**: Acts as the primary access control wrapper. It utilizes the `useEnsureTrial` hook to bootstrap trial periods for users and queries the subscription status. It conditionally renders children or redirects the user experience to the `PaywallOverlay` based on the `hasAccess` flag.
- **`PaywallOverlay.tsx`**: A presentational component that provides a non-dismissible UI barrier. It consumes subscription metadata to customize messaging (e.g., distinguishing between a trial expiration and a payment failure) and provides navigation to pricing tiers.
- **`TrialBanner.tsx`**: A contextual notification component that displays the current subscription status at the top of the interface. It handles logic for "urgency" (e.g., highlighting when <3 days remain) and manages local dismissal state for non-critical warnings.
- **`CheckoutReturnSync.tsx`**: A functional utility component that handles the asynchronous "handshake" between Stripe and the application backend. It listens for `checkout=success` and `session_id` URL parameters to trigger a POST request to the internal confirmation API, ensuring the local cache is refreshed and the user is notified of successful activation.

#### Key Dependencies and Technical Logic

- **Convex Integration**: All components rely on `convex/react` for real-time subscription data. The `api.subscriptions.checkAccess` and `api.subscriptions.get` endpoints are critical for determining the UI state.
- **Stripe Synchronization**: The system uses a client-side sync mechanism (`CheckoutReturnSync`) to bridge the gap between a successful Stripe transaction and the backend database update, preventing "access lag" after a purchase.
- **Visual Feedback**: Uses `lucide-react` for iconography and a combination of Tailwind CSS blurs and backdrops to indicate locked content states within the `SubscriptionGate`.

#### Important Gotchas

- **Side Effects**: `SubscriptionGate` triggers trial creation as a side effect via `useEnsureTrial`. This ensures users are never in a "null" subscription state while browsing protected routes.
- **State Persistence**: The dismissal state in `TrialBanner` is currently managed via local component state; it does not persist across page reloads unless the user enters an "expired" state, which makes the banner non-dismissible.
- **URL Cleanup**: `CheckoutReturnSync` automatically strips Stripe-related query parameters from the URL after a successful or failed sync to maintain clean navigation state.
