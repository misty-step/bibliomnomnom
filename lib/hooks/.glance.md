The `/lib/hooks` directory serves as the orchestration layer between the application's UI, the Convex backend, and Clerk authentication. Its primary purpose is to manage complex asynchronous states related to user identity, database provisioning, and subscription lifecycles, ensuring that data fetching only occurs when the necessary prerequisites are met.

### Architecture and Key File Roles

The directory follows a hierarchical architecture where base authentication hooks are composed into more complex logic for subscription management and safe data fetching:

- **`useAuth.ts`**: Acts as a thin abstraction over `useConvexAuth`, providing a standardized interface for checking the loading and authentication status of the current session.
- **`useAuthedQuery.ts`**: Implements a defensive data-fetching pattern. It wraps the standard Convex `useQuery` but injects a gatekeeper logic that waits for both authentication and user provisioning (via `useUserProvisioning`). This architecture prevents a common race condition where a query might execute before the backend has finished creating the user record in the database.
- **`useEnsureTrial.ts`**: Manages the side-effect of user onboarding. It monitors the user's subscription status and automatically triggers a mutation to create a trial if one does not exist. It utilizes `useRef` and `useEffect` to ensure idempotency, preventing multiple mutation calls during rapid re-renders or identity changes.
- **`useSubscriptionState.ts`**: Provides a state machine for the UI by transforming raw query data into a discriminated union (`SubscriptionState`). It handles the logic for calculating trial urgency (e.g., the `isUrgent` flag for â‰¤ 3 days) and maps various backend statuses (active, canceled, expired) into actionable states for context-aware UI rendering.

### Dependencies and Key Behaviors

- **External Dependencies**: The hooks rely heavily on `@clerk/nextjs` for identity and `convex/react` for real-time data synchronization.
- **Provisioning Dependency**: `useAuthedQuery` depends on a custom `useUserProvisioning` hook (located in the `ConvexClientProvider`), making it tightly coupled with the application's global initialization flow.
- **Query Skipping**: Both `useAuthedQuery` and `useSubscriptionState` utilize Convex's "skip" pattern to optimize performance and prevent unauthorized network requests when the user is not signed in.
- **State Management Gotchas**: `useEnsureTrial` includes specific logic to reset its internal trigger when a user logs out and logs back in with a different account, preventing stale local state from blocking trial creation for the new user.
