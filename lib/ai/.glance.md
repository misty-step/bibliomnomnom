The `lib/ai` directory serves as the centralized integration layer for Artificial Intelligence capabilities within the application. Its architecture is designed to decouple model selection and configuration from the underlying API implementation, facilitating flexible model routing and robust error handling through the OpenRouter gateway.

### Architecture and Key Components

The directory is structured into two primary functional areas: configuration management and API communication.

- **Model Configuration (`models.ts`):** This file acts as the registry for the application's AI strategy. It standardizes on `google/gemini-3-flash-preview` across different domains, including Optical Character Recognition (OCR) for photo quote capture, text extraction for imports, and reader profile generation. The architecture includes a tiered fallback strategy for profile generation, utilizing `deepseek/deepseek-chat` and `qwen/qwen3-235b-a22b` to maintain availability and cost-efficiency in the event of rate limits (429 errors) or primary model failures.
- **API Implementation (`openrouter.ts`):** This file provides a strictly typed client for the OpenRouter API. It manages the lifecycle of chat completion requests, including header management (Referer and X-Title for OpenRouter rankings), timeout logic using the `AbortController` API, and payload construction. It supports advanced OpenRouter features such as structured output via `json_schema`, multi-part content for image processing, and provider-specific reasoning toggles.

### Error Handling and Data Integrity

The communication layer implements a sophisticated error-parsing mechanism. It extracts granular details from OpenRouter's nested error objectsâ€”specifically parsing the `metadata.raw` string to retrieve provider-specific messages and request IDs. This is encapsulated in a custom `OpenRouterApiError` class, which ensures that upstream callers receive descriptive diagnostic information rather than generic HTTP failures.

### Key Dependencies and Technical Constraints

- **OpenRouter API:** The system is dependent on OpenRouter as a proxy; any changes to their schema or authentication requirements will impact this directory.
- **Timeouts:** Requests have a hard-coded default timeout of 300 seconds, specifically to accommodate high-latency tasks like OCR or complex profile generation.
- **Structured Outputs:** The client is designed to support `json_schema` and `json_object` response formats, requiring compatible models to be selected in `models.ts` for operations necessitating structured data.
- **Environment Context:** The API client expects a valid API key and relies on specific HTTP headers (`HTTP-Referer`) to satisfy OpenRouter's integration requirements.
