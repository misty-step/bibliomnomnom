The root `lib` directory serves as the applicationâ€™s core utility and integration layer, centralizing cross-cutting concerns such as error monitoring, payment processing, data serialization, and infrastructure configuration. The architecture emphasizes modularity and environment safety, providing specialized handlers for server-side operations, client-side interactions, and shared constants used by the Convex backend.

### Key Files and Roles

- **`stripe.ts` & `stripe-utils.ts`**: Manages the server-side Stripe integration. `stripe.ts` utilizes a lazy initialization pattern to prevent build-time failures when environment variables are absent and includes runtime validation for secret keys. `stripe-utils.ts` provides a deterministic mapping layer that translates complex Stripe subscription lifecycles into a simplified internal status enum (`trialing`, `active`, `canceled`, `past_due`, `expired`).
- **`sentry-config.ts` & `sentry.ts`**: Implements a robust error-reporting infrastructure. `sentry-config.ts` contains a sophisticated, recursive PII-scrubbing engine designed for GDPR compliance, redacting emails and sensitive headers (e.g., `Authorization`, `Cookie`) across exceptions, breadcrumbs, and request metadata. `sentry.ts` provides client-safe wrappers for capturing exceptions without importing Node.js-specific dependencies.
- **`export.ts` & `download.ts`**: Facilitates data portability. `export.ts` contains transformation logic to serialize library data into JSON, Markdown, and Goodreads-compatible CSV formats. `download.ts` provides a client-side utility to trigger browser downloads using the `Blob` and `URL.createObjectURL` APIs.
- **`constants.ts`**: Acts as a dependency-free source of truth for business logic primitives, such as trial durations and audio upload limits. This file is intentionally isolated to allow for safe import within Convex functions and other restricted environments.
- **`logger.ts`**: Configures a `pino` logger with environment-aware transports, utilizing `pino-pretty` for human-readable development logs while defaulting to standard JSON output in production for aggregator ingestion.
- **`utils.ts` & `format.ts`**: Provides low-level UI and string utilities. `utils.ts` exports a `cn` helper combining `clsx` and `tailwind-merge` for predictable CSS class composition, while `format.ts` handles grammatical pluralization logic.

### Dependencies and Technical Constraints

- **Server vs. Client Contexts**: Several modules have strict execution environment requirements. `stripe.ts` and `logger.ts` are intended for server-side or Edge runtime use, while `download.ts` and the `cn` utility rely on browser-specific globals or DOM APIs.
- **Convex Compatibility**: `constants.ts` must remain free of external npm dependencies to ensure it can be bundled within Convex's isolated backend environment.
- **Stripe API Versioning**: The Stripe client is pinned to the `2026-01-28.clover` API version, requiring manual synchronization if Stripe dashboard settings are updated.
- **PII Scrubbing Heuristics**: The Sentry scrubbing logic relies on a permissive regular expression for email detection; while effective for GDPR compliance, it may result in over-matching in technical logs containing complex strings or internal identifiers.
- **Tailwind Integration**: The `cn` utility in `utils.ts` is the standard entry point for resolving Tailwind CSS class conflicts, ensuring that the last-defined utility class takes precedence in the DOM.
