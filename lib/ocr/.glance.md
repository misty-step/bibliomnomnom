The `/lib/ocr` directory provides a specialized utility layer for processing and normalizing text extracted via Optical Character Recognition (OCR). Its primary purpose is to transform raw, artifact-heavy OCR output into clean, human-readable text suitable for book quotes and excerpts by resolving common scanning issues such as hard line breaks, mid-word hyphenation, and improper spacing.

### Architecture and Key Files

The directory follows a functional utility pattern, separating text transformation logic from configuration constants and quality assurance tests.

- **`format.ts`**: This is the core logic engine. It implements a multi-stage pipeline for text cleaning:
  - **Block Segmentation**: It splits input text by double newlines to isolate paragraphs.
  - **Line Unwrapping**: Within paragraphs, it merges lines while handling edge cases like trailing hyphens (de-hyphenation) and em-dashes (preserving continuity without adding spaces).
  - **Normalization**: It performs final cleanup by stripping soft hyphens (`\u00ad`), collapsing redundant whitespace, and removing erroneous spaces preceding punctuation marks.
- **`limits.ts`**: A configuration module that defines architectural constraints for image processing. It establishes a 5MB threshold (`MAX_IMAGE_BYTES`) and calculates the corresponding character limits for Base64-encoded payloads and Data URLs, accounting for the ~33% overhead inherent in Base64 encoding.
- **`format.test.ts`**: A Vitest-based suite that validates the heuristics of the formatter, ensuring that paragraph breaks are preserved while various types of line-wrap artifacts are correctly resolved.

### Dependencies and Technical Constraints

- **Vitest**: The module relies on `vitest` for unit testing the formatting logic.
- **ASCII-Centric Heuristics**: The `isLetter` utility in `format.ts` uses a simplified ASCII regex (`/[A-Za-z]/`). This avoids the overhead of heavy Unicode-aware regular expressions but may result in incorrect de-hyphenation for text containing accented characters or non-Latin scripts.
- **Hardcoded Limits**: The memory and payload constraints in `limits.ts` are static values. If the upstream OCR provider or the server environment changes its maximum payload size, these constants must be manually synchronized.
- **Soft Hyphen Removal**: The formatter explicitly strips the `\u00ad` character, which is common in digital text but often appears as an artifact in OCR pipelines.
