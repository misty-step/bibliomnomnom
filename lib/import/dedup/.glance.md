The `lib/import/dedup` directory implements the deduplication engine for the book import pipeline. Its primary purpose is to identify matches between incoming book data and a user's existing library to prevent redundant entries. The architecture follows a functional approach, separating data retrieval from the matching logic.

### Architecture and Key Files

- **`core.ts`**: This file contains the primary business logic for identifying duplicates. The `matchBooks` function utilizes a tiered matching strategy with varying confidence levels:
  - **ISBN (Confidence 1.0)**: The highest priority match, using normalized ISBN strings.
  - **Title-Author (Confidence 0.8)**: A fallback match using a composite key generated from the book title and author.
  - **API ID (Confidence 0.6)**: A match based on external provider identifiers (e.g., Google Books ID).
    The implementation uses `Map` structures to perform O(n) lookups for incoming rows against existing records, ensuring efficient processing during batch imports.

- **`repository.ts`**: This file serves as the data access layer. It defines `fetchUserBooks`, which encapsulates the Convex database query logic. It leverages the `by_user` index to retrieve all book documents associated with a specific `userId`, providing the necessary state for the matching engine.

### Dependencies and Integration

The module is tightly integrated with the Convex data model and relies on external normalization utilities:

- **Normalization**: It imports `normalizeIsbn`, `normalizeApiId`, and `normalizeTitleAuthorKey` from the parent `import` directory. These utilities are critical for ensuring that minor formatting differences (e.g., hyphens in ISBNs or casing in titles) do not result in false negatives.
- **Data Model**: It utilizes generated types from `@/convex/_generated` for strict type safety regarding document structures (`Doc<"books">`) and ID formats.

### Technical Considerations

- **Sequential Matching**: The matching logic is prioritized and short-circuits. Once an ISBN match is found, the engine does not evaluate Title-Author or API ID matches for that specific row.
- **In-Memory Processing**: The engine fetches a user's entire library into memory to perform matching. While efficient for standard library sizes, memory overhead scales linearly with the number of existing books and incoming rows.
- **Index Dependency**: The repository layer requires a `by_user` index to be defined on the `books` table within the Convex schema to perform efficient data retrieval.
