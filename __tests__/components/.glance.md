The `/Users/phaedrus/Development/bibliomnomnom/__tests__/components` directory contains the test suite for subscription-related UI components, focusing on the validation of conditional rendering, user messaging, and interactive states relative to a user's subscription lifecycle. The architecture follows a behavioral testing pattern that isolates UI logic from the backend and routing layers through extensive mocking.

### Architecture and Key File Roles

The suite is designed to simulate various subscription states by intercepting data-fetching hooks and routing components.

- **TrialBanner.test.tsx**: This is the primary test file for the `TrialBanner` component. It utilizes a state-driven approach to verify the component’s reaction to different backend payloads. The tests are structured to cover:
  - **Visibility Logic**: Ensuring the banner is absent during loading states or when a user has a fully active subscription.
  - **Trialing States**: Validating that the UI correctly displays the remaining trial duration with proper pluralization. It distinguishes between "standard" trialing (which allows user dismissal) and "urgent" trialing (3 days or fewer remaining), where the dismiss button is programmatically removed to maintain visibility.
  - **Expiration Handling**: Verifying that both trial and subscription expirations trigger high-priority, non-dismissible alerts that redirect users to the pricing interface.
  - **Interaction Verification**: Testing the local state logic that allows users to hide non-critical notifications.

### Key Dependencies

- **Vitest**: The core test runner and mocking engine used for spy and stub management.
- **@testing-library/react**: The primary utility for rendering components and performing DOM-based assertions.
- **Convex (convex/react)**: The application’s data layer. The `useQuery` hook is heavily mocked to simulate various subscription objects including `hasAccess`, `status`, `daysRemaining`, and `reason`.
- **Next.js (next/link)**: The routing layer. The `Link` component is mocked to provide functional anchor tags, bypassing the need for a full Next.js Router context during testing.

### Important Gotchas

- **Mock State Management**: Because the suite relies on `vi.fn()` for the data layer, explicit `beforeEach` resets are required to prevent state leakage between different subscription scenarios (e.g., an "active" state test affecting an "expired" state test).
- **Urgency Logic Constraints**: The component’s business logic dictates that the "dismiss" button is conditionally rendered based on the `daysRemaining` count and `hasAccess` boolean. Tests specifically target the absence of the "X" button in critical states to ensure mandatory alerts cannot be bypassed by the user.
- **Routing Context**: Components using `next/link` will trigger errors in the test environment unless the router is mocked or the component is wrapped in a provider, as the Vitest environment lacks the native Next.js navigation context.
