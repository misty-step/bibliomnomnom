This directory contains the test suite for the application's webhook infrastructure, specifically focusing on the integration between Clerk authentication and the Convex database backend. The primary architectural goal of these tests is to validate that user lifecycle events (creation, updates, and deletions) triggered by Clerk are correctly synchronized to the database while ensuring security protocols are maintained.

### Architecture and Key File Roles

The directory currently centers on `clerk.test.ts`, which utilizes the **Vitest** framework to perform unit and integration testing of the `POST` handler located in the Clerk webhook route. The testing architecture employs a "mock-heavy" approach to isolate the business logic of the API route from external network dependencies:

- **`clerk.test.ts`**: This file serves as the comprehensive test runner for the `/api/webhooks/clerk` endpoint. It simulates the Next.js request environment, including the injection of cryptographic headers and JSON payloads. It verifies that the incoming Svix-signed payloads are correctly parsed and that the corresponding Convex mutations are invoked with the expected parameters.

### Mocking Strategy and Dependencies

The test suite relies on several critical dependencies and mocking patterns to simulate a production environment:

- **Svix**: The `svix` library is mocked to simulate the verification of webhook signatures. The tests validate both successful verification and failure scenarios (e.g., "Invalid signature").
- **Convex**: The `ConvexHttpClient` is mocked to intercept database mutations. This allows the suite to assert that the correct data mapping occursâ€”such as concatenating `first_name` and `last_name` into a single `name` field or falling back to secondary email addresses if the primary is missing.
- **Next.js Headers**: The `next/headers` module is mocked to provide the required `svix-id`, `svix-timestamp`, and `svix-signature` headers that the route handler expects for security validation.
- **Module Hoisting**: The suite uses `vi.hoisted` to ensure that mock functions are initialized before the API route is imported, preventing the real Convex or Svix clients from being instantiated during tests.

### Key Logic and Gotchas

- **Environment Variables**: The tests explicitly manage `process.env.CLERK_WEBHOOK_SECRET`. A failure to provide this secret results in a `500 Internal Server Error`, which is a covered test case.
- **Data Normalization**: The tests specifically check for edge cases in user data, such as null name fields, missing primary emails, and the extraction of image URLs.
- **Idempotency and Unhandled Events**: The suite ensures that unhandled Clerk event types (e.g., `session.created`) return a `200 OK` status without triggering database mutations, preventing unnecessary errors while acknowledging receipt.
- **Error Handling**: The architecture differentiates between client-side errors (400) for signature or payload issues and server-side errors (500) for configuration or database failures.
