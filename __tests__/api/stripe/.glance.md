This directory serves as the integration and unit testing suite for the application's billing and subscription infrastructure. The architecture utilizes Vitest to simulate interactions between the Next.js API layer and three primary external systems: Stripe (payment processing), Clerk (authentication), and Convex (backend database and serverless functions).

### Key File Roles

- **`checkout.test.ts`**: Validates the initial creation of Stripe Checkout sessions. It ensures that the system correctly identifies existing customers, applies appropriate trial periods (handling logic for new users vs. users with remaining trial time), and enforces rate limiting via Convex mutations to prevent abuse.
- **`checkout.confirm.route.test.ts`**: Focuses on the post-checkout verification process. It tests the logic that retrieves a Stripe session, verifies ownership by comparing Clerk metadata, and performs the initial synchronization of subscription data into the Convex database.
- **`webhook.route.test.ts`**: Tests the asynchronous handler for Stripe webhook events. It covers the subscription lifecycle, including session completion, subscription updates, and deletions. It validates signature verification, idempotency checks to prevent duplicate processing, and the mapping of Stripe statuses to internal application states.
- **`webhook.test.ts`**: Provides unit tests for utility functions that transform Stripe-specific data, such as converting Unix timestamps (seconds) to JavaScript timestamps (milliseconds) and normalizing Stripe's subscription status strings into the internal domain model.

### Architecture and Dependencies

The test suite relies heavily on `vi.hoisted` to mock complex SDKs and the `ConvexHttpClient`. The routes are tested as standalone POST handlers, simulating `Request` objects and asserting on `Response` outputs.

**Primary Dependencies:**

- **Stripe SDK**: Used for session management, subscription retrieval, and webhook signature verification.
- **Clerk (@clerk/nextjs/server)**: Provides user identity and authentication tokens.
- **Convex (convex/browser)**: Acts as the persistent store for subscription status and the engine for rate-limiting logic.
- **withObservability**: A custom middleware wrapper for logging and monitoring, which is bypassed during testing to focus on core business logic.

### Important Logic and Gotchas

- **Trial Management**: The system includes specific logic to honor remaining trial time if a user upgrades mid-trial, though it ignores trial periods if the remaining duration is less than 48 hours.
- **Security & Validation**: Every route enforces strict authentication. The webhook route specifically requires a valid `stripe-signature` and an internal `CONVEX_WEBHOOK_TOKEN` to permit backend mutations.
- **Metadata Reliance**: The integration depends on a `clerkId` being present in Stripe metadata. The webhook handler includes fallback logic to check both session and subscription metadata to ensure the correct user is updated.
- **Error States**: The tests explicitly cover 503 Service Unavailable states, which occur if environment variables like `CONVEX_WEBHOOK_TOKEN` are missing or if the backend preflight check fails.
