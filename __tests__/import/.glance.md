This directory contains the comprehensive test suite for the book import system, encompassing file parsing, deduplication logic, state management, and Convex backend integration. The architecture utilizes **Vitest** for unit and integration testing, employing a multi-layered approach that validates individual utility functions, React hooks, and server-side handlers through extensive mocking of the Convex database and external LLM providers.

### Key File Roles

- **Parsing and Ingress**: `goodreads.test.ts` and `csvInfer.test.ts` validate the transformation of specific and generic CSV formats into internal data structures. `reading-summary.test.ts` tests a specialized Markdown parser that handles year-contextual date extraction.
- **Deduplication and Normalization**: `dedup.test.ts` and `dedup.repository.test.ts` verify the logic for matching incoming books against existing library records using ISBNs, API identifiers, and fuzzy title-author keys. `normalize.ts` (tested via `types.test.ts`) ensures consistency by stripping diacritics and punctuation.
- **LLM Extraction**: `llm-extraction.test.ts`, `llm.test.ts`, and `llm.coverage.test.ts` cover the AI-assisted parsing pipeline. These tests validate retry logic for transient provider failures, token budget enforcement, and the server-only execution requirement.
- **State and Workflow**: `useImportJob.test.tsx` validates the state machine governing the multi-step import process (upload, preview, decision-making, and commitment). `ImportFlow.backfill.test.tsx` ensures the UI correctly triggers post-import actions like cover image retrieval.
- **Backend Integration**: `imports.action.test.ts` and `imports.commit.test.ts` test the Convex server functions responsible for generating previews and persisting finalized records, using a mock database context to simulate fluent query chains.
- **Infrastructure**: `rateLimit.test.ts` validates the enforcement of daily and concurrent import quotas per user.

### Architecture and Dependencies

The suite relies on **Vitest** for test execution and **React Testing Library** for hook and component validation. Key dependencies include:

- **Convex Data Model**: Specifically `@/convex/_generated/dataModel` for branded types (e.g., `Id<"users">`) used in repository mocks.
- **Next.js Navigation**: Mocked to validate routing after successful imports.
- **Global Fetch**: Stubbed to simulate OpenRouter API responses for LLM extraction tests.

### Important Considerations and Gotchas

- **Server-Only Execution**: The LLM extraction logic explicitly checks for the absence of a `window` object. Tests must manually delete and restore `global.window` to simulate the server environment correctly.
- **Fluent API Mocking**: Testing Convex handlers requires complex mock objects that support chained method calls (e.g., `db.query().withIndex().collect()`). Failure to return `this` in these mocks will cause runtime errors in the test environment.
- **Environment-Specific Logic**: Rate limiting behavior changes based on `NODE_ENV`. Tests must use `vi.stubEnv` to ensure consistent behavior across development and production logic paths.
- **Date Normalization**: The Markdown parser utilizes a specific "noon UTC" strategy for date extraction to prevent timezone shifts from altering the intended publication or finish dates.
- **Branded Types**: Because the system uses Convex's branded string types for IDs, many tests require explicit type casting (e.g., `as Id<"books">`) to satisfy the TypeScript compiler.
