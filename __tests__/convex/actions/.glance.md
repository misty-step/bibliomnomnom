This directory contains the Vitest-based unit and integration tests for Convex actions responsible for external book metadata and imagery retrieval. The test suite focuses on validating the integration with the Open Library and Google Books APIs, ensuring robust data transformation and error handling for the application's core search and cover-fetching functionality.

### Architecture and Key File Roles

The testing architecture relies on mocking the global `fetch` API to simulate network responses, allowing for deterministic testing of asynchronous logic without making actual HTTP requests.

- **`bookSearch.test.ts`**: Validates the logic for querying the Open Library Search API. It tests the `searchBooksHelper` and various utility functions. Key areas of coverage include:
  - **ISBN Extraction**: Verifies that the system correctly prioritizes ISBN-13 over ISBN-10 and handles malformed identifiers.
  - **Data Mapping**: Ensures raw `OpenLibraryDoc` objects are correctly transformed into the internal `SearchResult` schema, including author concatenation and cover URL construction.
  - **Request Validation**: Confirms that outgoing requests include required headers (e.g., `User-Agent`), specific field filters, and result limits.
- **`coverFetch.test.ts`**: Tests the multi-source fallback strategy for retrieving book cover images. It validates the `searchBookCoverHelper` logic, which orchestrates calls across multiple services:
  - **Source Prioritization**: Verifies that Google Books is preferred when an API key is present, falling back to Open Library ISBN and Search APIs sequentially.
  - **Image Processing**: Simulates the download of image buffers and validates the handling of various content types.
  - **Input Sanitization**: Ensures ISBNs are stripped of dashes and non-numeric characters before being passed to external APIs.

### Important Dependencies

- **Vitest**: The primary test runner and mocking library, utilized for test suite organization (`describe`, `it`) and implementation spying (`vi.fn`).
- **Global Fetch API**: Since Convex actions run in a runtime providing `fetch`, the tests heavily manipulate the `global.fetch` object to simulate successful responses, 404s, and network timeouts.
- **NodeJS Process Environment**: Tests for Google Books integration dynamically modify `process.env.GOOGLE_BOOKS_API_KEY` to trigger different conditional logic paths within the actions.

### Gotchas

- **Global State Management**: Because `fetch` is mocked on the `global` object, tests must carefully reset mocks in `afterEach` blocks to prevent cross-test contamination.
- **Timeout Simulation**: The `coverFetch` logic includes internal timeout thresholds (e.g., 8000ms). Tests simulate these by rejecting the fetch promise or using delayed resolutions to ensure the application returns a "Cover not found" error rather than crashing.
- **ISBN Formatting**: The extraction logic contains a specific fallback mechanism that defaults to the first available string if no valid ISBN-10 or ISBN-13 is detected, which is critical for handling inconsistent API data.
