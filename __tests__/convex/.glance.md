This directory contains the Vitest-based test suite for the Convex backend of the bibliomnomnom application. Its primary purpose is to validate the business logic, state transitions, and access control for three core domains: audio listening sessions, subscription management, and book cover metadata retrieval.

### Architecture and Key File Roles

The testing architecture utilizes a mock-heavy approach to simulate the Convex runtime environment. Each test file typically implements a `makeCtx` factory function that provides a mock database (`db`), query runner (`runQuery`), and action/mutation triggers. This allows for deterministic testing of backend logic without a running Convex instance.

- **`listeningSessions.test.ts`**: Validates a complex state machine for audio processing. It ensures sessions transition correctly through `recording`, `transcribing`, `synthesizing`, and `complete` or `failed` states. Key logic includes duration normalization (clamping values between 60s and 4 hours), transcript truncation at 4,000 characters, and the automated generation of raw and synthesized notes upon session completion.
- **`subscriptions.test.ts`**: Focuses on access control logic and trial management. It tests the `hasAccess` and `getDaysRemaining` utilities against various Stripe statuses (`trialing`, `active`, `past_due`, `canceled`, `expired`) and validates the 14-day internal trial logic.
- **`books.listMissingCovers.test.ts`**: Unit tests the query logic for identifying books without imagery. It simulates Convex database indexing and pagination to ensure users only see their own books and that results are correctly limited and cursored.
- **`books.fetchCover.test.ts` & `books.fetchMissingCovers.test.ts`**: These files test the orchestration of Convex actions that call external APIs. They validate the logic for triggering cover fetches, handling API failures, and batch-processing missing covers while enforcing ownership checks.
- **`books.test.ts`**: Specifically validates the `updateCoverFromBlobHandler`, ensuring that when a cover is successfully processed and stored in blob storage, the corresponding database record is patched with the new URL and metadata.

### Important Dependencies

- **Vitest**: The core test runner, used for assertions, suite organization, and implementation spying via `vi.fn()` and `vi.spyOn()`.
- **Convex Data Model**: Tests import generated types (e.g., `Doc`, `Id`) to ensure type safety when mocking database records and ID strings.
- **Auth Modules**: The suite relies on mocking `requireAuth` and `requireAuthAction` from the application's internal auth utilities to simulate authenticated and unauthenticated states.

### Gotchas

- **Manual Mocking of Convex DB**: Because these tests do not run against a live Convex backend, the `db.query` behavior (including `withIndex` and `filter`) is manually re-implemented in `makeCtx` using standard JavaScript array methods. This requires careful alignment with actual Convex query semantics.
- **Fake Timers**: Many tests (particularly for subscriptions and session durations) utilize `vi.useFakeTimers()` to freeze or advance the system clock. Tests must be diligent about calling `vi.useRealTimers()` in `afterEach` to prevent side effects in subsequent tests.
- **Access Control Enforcement**: Every handler test explicitly verifies that operations fail (throw "Access denied") if the `userId` of the requester does not match the `userId` on the record, making ownership a critical component of the test data setup.
- **ID Casting**: Since Convex IDs are opaque strings with specific branding, the tests use type casting (e.g., `as unknown as Id<"books">`) to satisfy the TypeScript compiler within the mock environment.
