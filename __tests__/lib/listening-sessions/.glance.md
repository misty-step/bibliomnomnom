### Technical Overview: /listening-sessions Tests

This directory contains the test suite for the listening sessions module, focusing on the configuration of Large Language Model (LLM) synthesis and the reliability of Speech-to-Text (STT) transcription pipelines. The architecture employs a functional testing approach using **Vitest** to validate environment-driven configurations and multi-provider failover logic.

#### Key File Roles

- **`synthesisConfig.test.ts`**: Validates the logic for generating LLM configurations via `getListeningSynthesisConfig`. It ensures that the system correctly prioritizes environment variables (e.g., `OPENROUTER_LISTENING_MODEL`), applies sensible fallbacks for specific model families (such as Google Gemini or Anthropic Claude), and handles model-specific constraints like omitting temperature for OpenAI GPT-5 or parsing "reasoning effort" levels.
- **`transcription.test.ts`**: Tests the core audio processing and STT integration logic. It covers `readAudioFromUrl`, which enforces security constraints by validating against trusted hosts (specifically Vercel Blob Storage) and protocols. It also verifies the successful orchestration of transcription requests, handling of different response formats (ArrayBuffer vs. Stream), and enforcement of minimum transcript quality.
- **`transcription-fallback.test.ts`**: Specifically targets the resilience of the STT pipeline. It simulates provider failures—such as HTTP 503 errors or `AbortError` timeouts—to verify that the system gracefully falls back from the primary provider (ElevenLabs) to the secondary provider (Deepgram) without interrupting the user session.

#### Architecture and Logic

The directory follows a mock-heavy testing pattern where `global.fetch` is stubbed to simulate various network conditions and API responses. The STT logic is designed as a tiered fallback system:

1. **Ingestion**: Audio is fetched from a trusted URL with strict MIME type and size checks.
2. **Primary Provider**: The system attempts transcription using ElevenLabs.
3. **Fallback Provider**: If the primary fails or is unconfigured, the system attempts a recovery via Deepgram.
4. **Validation**: Results are rejected if they return empty strings or fail confidence thresholds.

#### Important Dependencies and Gotchas

- **Vitest**: Utilized for test execution, global mocking, and environment variable manipulation.
- **Environment Variable Sensitivity**: The logic is highly dependent on `process.env`. Tests include rigorous `beforeEach`/`afterEach` blocks to reset environment state, as leaking variables between tests can result in false positives for model selection or API key availability.
- **Security Constraints**: The audio ingestion logic includes a "trusted host" check. Tests explicitly verify that non-Vercel storage URLs are rejected to prevent SSRF or unauthorized data processing.
- **Model-Specific Behavior**: There is hardcoded logic for OpenAI's reasoning models (GPT-5 series) where `temperature` is intentionally omitted, reflecting specific API requirements for those models.
- **Deepgram Model Overrides**: The STT pipeline supports model-specific parameters (e.g., `nova-2`) passed via environment variables, which are verified through URL parameter inspection in the mocks.
