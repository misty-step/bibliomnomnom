The `__tests__/lib/security` directory contains the unit test suite for the application's security primitives, specifically focusing on webhook authentication and cryptographic string comparisons. The architecture follows a behavioral testing pattern designed to validate security-critical logic under both standard and adversarial conditions.

### Key File Roles

- **`webhookToken.test.ts`**: This file provides comprehensive coverage for two primary security functions:
  - `timingSafeCompare`: Validates that string comparisons are resilient to timing attacks. It specifically ensures that length mismatches and identical strings are handled correctly. A critical security invariant tested here is that empty strings are treated as non-matching, even if both inputs are empty, to prevent authentication bypasses.
  - `validateWebhookToken`: Tests the high-level orchestration of webhook security. This includes verifying integration with environment variables (specifically `CONVEX_WEBHOOK_TOKEN`), ensuring the function throws appropriate errors on unauthorized access, and validating that null or undefined inputs are rejected at runtime.

### Dependencies and Technical Details

The test suite utilizes **Vitest** as the primary test runner and assertion library. It employs `vi.spyOn` or direct `process.env` manipulation to simulate different environment configurations, requiring strict `beforeEach` and `afterEach` hooks to prevent state leakage between tests.

### Important Gotchas

- **Empty String Logic**: The implementation enforces a strict "no-match" policy for empty strings to mitigate risks associated with unset environment variables or missing request headers.
- **Runtime Type Safety**: The tests explicitly use `@ts-expect-error` to verify that the security functions fail gracefully when provided with invalid non-string types (e.g., `null` or `undefined`) that might bypass TypeScript's static analysis at runtime.
- **Environment Dependency**: `validateWebhookToken` defaults to checking `process.env.CONVEX_WEBHOOK_TOKEN` if a secondary argument is not provided, making the environment state a critical factor in successful test execution.
