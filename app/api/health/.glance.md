The `/app/api/health` directory implements a diagnostic API endpoint designed for uptime monitoring, deployment verification, and integration health tracking. The system is structured to provide both lightweight connectivity checks and deeper integration probes to ensure the application and its critical third-party dependencies are operational.

### Architecture and Key Files

The health system follows a modular pattern where the API logic is decoupled from the specific probe implementations located in the application's library modules.

- **`route.ts`**: This is the primary entry point for the `/api/health` endpoint. It leverages a Next.js Node.js runtime to execute service probes. The handler supports two operational modes:
  - **Shallow Mode**: The default state (invoked via no parameters or `mode=shallow`) which returns a `200 OK` status and basic metadata (uptime, environment, version) without performing active external checks.
  - **Deep Mode**: Triggered by a `?mode=deep` query parameter or an `x-health-mode: deep` header. This mode executes concurrent probes for external services within a defined time budget.
- **`route.test.ts`**: Located within the directory, this Vitest-based suite validates the endpoint logic. It mocks external probes and the observability wrapper to verify that the API correctly maps service states to HTTP status codes (200 for healthy, 503 for degraded or unhealthy).

### Key Dependencies

- **`@/lib/api/withObservability`**: A higher-order function used to wrap the handler for telemetry and operation tracking.
- **`@/lib/health/probes`**: Provides the functional probes for **Convex**, **Clerk**, and **Stripe**.
- **`@/lib/health/types`**: Contains the logic for calculating the `overallStatus` based on the collective results of individual service probes.
- **Next.js Metadata**: Utilizes Vercel-specific environment variables (`VERCEL_ENV`, `VERCEL_GIT_COMMIT_SHA`) to provide context about the running instance.

### Technical Gotchas

- **Execution Budget**: The `runProbesWithinBudget` function enforces a strict `750ms` total timeout, which is divided equally among the active probes (Convex, Clerk, and Stripe). Slow responses from third-party APIs will result in a timeout and a subsequent 503 status.
- **Status Mapping**: The endpoint returns a `503 Service Unavailable` for any status other than "healthy." This includes "degraded" states where a service might be reachable but underperforming, or "unhealthy" states where a probe throws an exception.
- **Cache Prevention**: The route explicitly sets `Cache-Control: no-store, no-cache, must-revalidate` to ensure that monitoring tools receive real-time data rather than cached responses.
- **Environment Variable Sensitivity**: Deep health checks rely on the presence of `NEXT_PUBLIC_CONVEX_URL`, `CLERK_JWT_ISSUER_DOMAIN`, and `STRIPE_SECRET_KEY`. Missing or incorrect variables in specific environments will cause probe failures.
