This directory contains the automated test suite for the application's health check API endpoint. Its primary purpose is to verify the functionality of the health monitoring system, ensuring it correctly reports the operational status of the application and its critical third-party integrations.

### Architecture and Key Files

The testing architecture utilizes **Vitest** to perform unit and integration testing on the Next.js API route handler. The suite is designed to simulate various system states—ranging from optimal performance to partial degradation and total service failure—by intercepting and mocking external dependencies.

- **`route.test.ts`**: This is the central test file. It imports the `GET` handler from the adjacent health route and executes test cases against it. It verifies the logic for two distinct operational modes:
  - **Shallow Health**: The default state which returns a `200 OK` status and reports services as "unknown" without performing active checks, ensuring the API itself is reachable.
  - **Deep Health**: Triggered via the `?mode=deep` query parameter, this mode invokes active probes for external services. The tests verify that the endpoint returns `200 OK` when all services are functional and `503 Service Unavailable` when any service fails or throws an exception.

### Key Dependencies

- **Vitest**: The testing framework used for assertions, mocking, and test lifecycle management.
- **`@/lib/health/probes`**: The test suite heavily mocks this module to simulate the behavior of connection probes for **Convex**, **Clerk**, and **Stripe**.
- **`@/lib/api/withObservability`**: A middleware wrapper that is mocked to return the raw handler, allowing the tests to focus on the business logic of the health check rather than the telemetry layer.

### Technical Gotchas

- **Middleware Bypass**: The `withObservability` higher-order function is explicitly neutralized in the mock setup to isolate the route handler logic.
- **State Management**: The suite uses `afterEach` hooks to restore `process.env` and clear mocks, preventing state leakage between tests that manipulate environment variables or mock return values.
- **Status Mapping**: The tests enforce a specific mapping of probe results to HTTP status codes: a "down" status results in a "degraded" response, while a code-level exception results in an "unhealthy" response, both returning a 503 status code.
