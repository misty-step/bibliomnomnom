This directory contains the test suite for the OCR (Optical Character Recognition) API endpoint. The primary focus is validating the `POST` handler's logic within the Next.js App Router environment, ensuring robust handling of authentication, external API communication, and data transformation.

### Architecture and Key File Roles

The testing architecture utilizes **Vitest** for unit testing and mocking. The suite is designed to isolate the route handler by intercepting network requests and middleware-like wrappers.

- **`route.test.ts`**: This file contains the test logic for the OCR route handler. It verifies three primary functional areas:
  - **Authentication**: Ensures the route returns a `401 UNAUTHORIZED` status when no valid session is provided via Clerk.
  - **Error Handling**: Validates that the system correctly translates external API failures (specifically from OpenRouter) into internal application errors, such as `OCR_MODEL_INVALID`.
  - **Data Transformation**: Tests the logic for cleaning and formatting raw text returned by the OCR model, including the reconstruction of paragraphs and the handling of line-end hyphens (e.g., converting "wrap-\nped" to "wrapped").

### Important Dependencies

- **Vitest**: The core test runner and mocking framework.
- **Clerk (`@clerk/nextjs/server`)**: Mocked to simulate identity management and authorization states.
- **OpenRouter**: The external service dependency is simulated by stubbing the global `fetch` API, allowing for the injection of successful and failed JSON responses.
- **Internal Observability**: The `@/lib/api/withObservability` higher-order function is mocked to bypass telemetry wrapping, allowing direct testing of the underlying handler logic.

### Gotchas and Implementation Details

- **Environment Variable Management**: The suite manually manages `process.env` for keys such as `OPENROUTER_API_KEY` and `OPENROUTER_OCR_MODEL`. It employs an `afterEach` cleanup pattern to restore original environment states, preventing configuration leakage between tests.
- **Global Stubs**: The use of `vi.stubGlobal("fetch", ...)` necessitates the use of `vi.unstubAllGlobals()` in the teardown phase to ensure the global environment is reset for other test files.
- **Request/Response Interception**: The tests instantiate standard Web API `Request` objects and parse `Response` objects, mimicking the actual runtime behavior of Next.js Route Handlers.
