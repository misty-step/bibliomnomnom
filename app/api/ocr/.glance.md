This directory implements the Optical Character Recognition (OCR) engine for the application, providing a Next.js App Router API endpoint that transforms images of book pages into structured, cleaned text.

### Architecture and Key File Roles

The directory follows a standard Next.js Route Handler pattern, centralizing logic within a single entry point while delegating specialized tasks to internal library utilities.

- **`route.ts`**: The primary controller for the `POST` endpoint. It orchestrates the entire OCR lifecycle:
  - **Identity & Observability**: Validates sessions using Clerk and wraps the handler in a `withObservability` higher-order function for structured logging and request ID tracking.
  - **Input Validation**: Enforces strict schema validation on incoming JSON payloads, specifically checking for base64 Data URLs, supported image media types, and size constraints (5MB limit).
  - **AI Orchestration**: Constructs a vision-capable prompt designed to reflow paragraphs and repair hyphenated line-breaks. It interfaces with OpenRouter to perform the actual text extraction.
  - **Error Mapping**: Translates various failure modes—such as authentication gaps, AI provider rate limits, invalid model configurations, and request timeouts—into standardized application error codes (e.g., `OCR_MODEL_INVALID`, `RATE_LIMITED`).
- **`tests/` (Subdirectory)**: A Vitest-based testing suite that isolates the route handler. It uses global fetch stubs and environment variable manipulation to verify authentication guards, error handling logic, and the accuracy of text transformation rules.

### Key Technical Logic

The OCR process utilizes a specific `EXTRACTION_PROMPT` that instructs the underlying model to return plain text while reflowing line-wrapped text into single paragraphs and joining words split by hyphens. The handler employs a fallback mechanism for model selection, checking `OPENROUTER_OCR_MODEL` and `OPENROUTER_MODEL` environment variables before defaulting to a pre-defined constant.

### Important Dependencies and Gotchas

- **Clerk**: Required for session management; the endpoint will return a `401 UNAUTHORIZED` if the user is not authenticated.
- **OpenRouter**: The external service dependency for LLM-based vision processing. The implementation expects a valid `OPENROUTER_API_KEY`.
- **Data URL Requirements**: The extraction logic uses a strict regular expression for base64 strings. It requires an explicit media type (e.g., `data:image/jpeg;base64,...`) and supports standard image formats including JPEG, PNG, and SVG.
- **Payload Limits**: There are two layers of size validation: a quick check on the raw string length (`MAX_DATA_URL_CHARS`) and a more precise check on the extracted base64 payload (`MAX_BASE64_PAYLOAD_CHARS`).
- **Timeout Management**: The AI request is governed by a 30-second `TIMEOUT_MS` threshold; exceeding this triggers a `504 Gateway Timeout` response to the client.
