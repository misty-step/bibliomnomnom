The `/app/api/stripe` directory serves as the centralized backend orchestration layer for the application's subscription-based billing system. It utilizes Next.js App Router API routes to interface between Clerk (Identity), Convex (State/Database), and Stripe (Payments), ensuring secure transaction handling and real-time state synchronization.

### Architecture

The directory is structured into functional endpoints that manage the full lifecycle of a subscription: initiation, management, and asynchronous status updates. It follows a "Server-to-Server" pattern where all financial logic and database mutations are performed in a secure environment using authenticated clients. The architecture emphasizes idempotency and pre-flight validation to prevent data desynchronization between the payment provider and the application backend.

### Key File Roles

- **Checkout Initiation (`/route.ts`)**: Orchestrates the transition to Stripe Checkout. It validates the user's session via Clerk, enforces a distributed rate limit (5 attempts/hour) via Convex, and performs a "preflight" check on environment configuration. It contains logic for dynamic trial calculation, determining whether to honor a remaining trial balance or apply a standard trial period based on the user's history.
- **Customer Portal (`/portal/route.ts`)**: Generates short-lived, authenticated redirect URLs to the Stripe Customer Portal. It retrieves the user's `stripeCustomerId` from Convex using a request-scoped JWT and offloads billing management (invoices, card updates, cancellations) to Stripe’s hosted infrastructure.
- **Webhook Handler (`/webhook/route.ts`)**: A high-integrity endpoint for processing asynchronous Stripe events. It follows a "Verify-Check-Process" pattern: validating Stripe signatures, verifying event idempotency against a `webhookEvents` table in Convex, and dispatching state updates for subscription creation, modification, or deletion.

### Key Dependencies

- **`stripe` SDK**: Used for session construction, billing portal management, and webhook signature verification.
- **`@clerk/nextjs`**: Provides server-side authentication and the JWT templates required to authorize the `ConvexHttpClient`.
- **`convex/browser`**: Supplies the `ConvexHttpClient` used for performing mutations and queries outside of the standard React hook context, essential for API route execution.
- **`@/lib/api/withObservability`**: A custom higher-order function used across all routes for structured logging, request ID tracking, and error telemetry.

### Important Gotchas

- **Trial Timing Constraints**: Stripe requires `trial_end` to be at least 48 hours in the future. The checkout logic includes a `MIN_TRIAL_MS` buffer; if a user's remaining trial is too short, the system may default to immediate billing.
- **Webhook Token Circuit Breaker**: The checkout route will return a `503 Service Unavailable` if the `CONVEX_WEBHOOK_TOKEN` is missing or out of sync. This prevents users from completing purchases that the backend cannot verify.
- **Metadata Dependency**: The system relies heavily on the `clerkId` being present in Stripe metadata. Downstream synchronization in the webhook handler will fail or require expensive fallback lookups if this metadata is not correctly injected during session creation.
- **Idempotency Management**: The webhook handler is designed to return a `500` error on processing failure to trigger Stripe’s retry logic, while simultaneously using an event log to ensure that retried events do not result in duplicate database mutations.
- **Single-Price Model**: The current implementation assumes a single-item subscription model, accessing line items via the first index of the Stripe data array. This logic would require modification to support multi-plan or add-on billing.
