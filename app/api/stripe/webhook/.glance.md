### Technical Overview: /app/api/stripe/webhook

This directory contains the edge-compatible API route responsible for processing asynchronous event notifications from Stripe. Its primary purpose is to synchronize subscription states, trial periods, and payment statuses between Stripe and the Convex backend.

#### Architecture

The directory follows a standard Next.js Route Handler pattern, employing a "Verify-Check-Process" architecture:

1.  **Verification:** The handler validates incoming requests using Stripe signature headers to ensure authenticity.
2.  **Idempotency:** Before processing, it queries the Convex database to determine if the specific `event.id` has already been handled, preventing duplicate state updates.
3.  **Dispatching:** Validated events are routed to specialized internal handlers based on the event type.
4.  **Backend Integration:** State changes are persisted to the Convex database via `ConvexHttpClient`, utilizing internal actions secured by a shared webhook token.
5.  **Observability:** All operations are wrapped in a logging utility that sanitizes identifiers and tracks event lifecycles.

#### Key File Roles

- **`route.ts`**: The central entry point for the webhook endpoint. It defines the `POST` handler and implements the logic for:
  - `checkout.session.completed`: Initializing new subscriptions and mapping Stripe customers to internal `clerkId` users.
  - `customer.subscription.updated`: Handling renewals, plan changes, and status transitions (e.g., moving to `past_due`).
  - `customer.subscription.deleted`: Managing subscription expirations and cancellations.
  - **Idempotency Management**: Persisting processed event IDs to the `webhookEvents` table.

#### Important Dependencies and Gotchas

- **Dependencies**: The route relies on the `stripe` SDK for event construction and the `convex/browser` client for server-side database interaction. It also utilizes shared utilities in `@/lib/stripe` for timestamp conversion and status mapping.
- **Security Tokens**: The implementation requires `STRIPE_WEBHOOK_SECRET` for request validation and `CONVEX_WEBHOOK_TOKEN` for authorizing Convex action calls. Missing environment variables will cause the webhook to fail with internal error logs.
- **Clerk ID Mapping**: The system heavily relies on `clerkId` being present in Stripe metadata. A fallback mechanism is implemented to retrieve the subscription object directly if the metadata is missing from the initial webhook payload.
- **Retry Logic**: The handler is designed to return a `500 Internal Server Error` status code upon processing failures. This is intentional to trigger Stripeâ€™s automatic retry schedule for transient issues.
- **Data Consistency**: Subscription items are accessed via the first index of the `items.data` array, assuming a single-price subscription model. Statuses are mapped from Stripe's native strings to application-specific enums via `mapStripeStatus`.
