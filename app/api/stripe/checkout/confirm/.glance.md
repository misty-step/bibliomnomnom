This directory implements a specialized API endpoint for verifying and synchronizing Stripe Checkout sessions. Its primary purpose is to provide an "eager" synchronization mechanism that updates the application's subscription state immediately after a user completes a checkout flow, ensuring low-latency access to premium features without solely relying on asynchronous Stripe webhooks.

### Architecture

The directory follows the Next.js App Router convention for API routes. The architecture functions as a secure bridge between the client-side checkout completion, the Stripe API, and the Convex backend. It utilizes a verification-first approach: rather than trusting client-provided data, the handler uses the provided `sessionId` to fetch the authoritative state directly from Stripe's servers before updating the internal database.

### Key File Roles

- **`route.ts`**: The core logic provider. It exports a `POST` handler wrapped in an observability higher-order function. It performs several critical operations:
  - **Authentication & Authorization**: Validates the user's Clerk session and ensures the Stripe session or subscription metadata contains a `clerkId` matching the authenticated user.
  - **Stripe Integration**: Retrieves the Checkout Session and the associated Subscription object to extract status, price IDs, and period boundaries.
  - **Convex Synchronization**: Uses the `ConvexHttpClient` to trigger the `subscriptions.upsertFromWebhook` action. This is performed using a privileged `CONVEX_WEBHOOK_TOKEN` to allow the server to update records on behalf of the user.
  - **Access Verification**: Performs a secondary check via `subscriptions.checkAccess` using the user's specific Convex identity to return the final access state to the frontend.

### Key Dependencies

- **`@clerk/nextjs`**: Manages user authentication and provides the JWT templates required for Convex authorization.
- **`stripe`**: Used for server-side retrieval of session and subscription details.
- **`convex/browser`**: Provides the `ConvexHttpClient` used to execute database mutations and queries from a server-side environment.
- **`@/lib/api/withObservability`**: A custom wrapper for structured logging and request ID tracking.

### Important Gotchas

- **Metadata Requirement**: The logic strictly requires that the Stripe Checkout Session or Subscription object includes a `clerkId` in its metadata. If this was not set during the session creation, the confirmation will fail with a 403 Forbidden error.
- **Mode Restriction**: The handler is explicitly hardcoded to support only `subscription` mode sessions; one-time payments or other checkout modes will trigger a 400 Bad Request.
- **Environment Variables**: The endpoint will return a 503 Service Unavailable if `CONVEX_WEBHOOK_TOKEN` is missing, and a 500 Internal Server Error if `NEXT_PUBLIC_CONVEX_URL` is not configured.
- **Manual Sync vs. Webhooks**: This route manually triggers a function typically reserved for webhooks (`upsertFromWebhook`). The underlying Convex action must be idempotent to prevent conflicts with Stripe's actual asynchronous webhook deliveries.
