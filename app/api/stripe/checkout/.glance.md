This directory implements a secure server-side endpoint for initiating Stripe Checkout sessions for subscription-based billing. It manages the transition from the application's pricing interface to Stripeâ€™s hosted checkout, incorporating complex business logic for trial eligibility, anti-abuse measures, and environment synchronization.

### Architecture

The directory follows the Next.js App Router convention for API routes. The architecture functions as an orchestrator between four primary systems: Clerk (Identity), Convex (State and Rate Limiting), Stripe (Payments), and a custom Observability layer. It utilizes a "preflight-check" pattern where the system validates environment integrity and user limits before attempting any external financial transactions.

### Key File Roles

- **`route.ts`**: The primary logic provider. It exports a `POST` handler wrapped in a structured logging HOF. Its execution flow includes:
  - **Identity Verification**: Validates the Clerk session and retrieves the user's primary email address.
  - **Distributed Rate Limiting**: Uses the `ConvexHttpClient` to execute a `rateLimit.check` mutation, restricting users to five checkout attempts per hour.
  - **Configuration Audit**: Executes a "preflight" action (`subscriptions.assertWebhookConfiguration`) to ensure the `CONVEX_WEBHOOK_TOKEN` is correctly synchronized between the server environment and the Convex backend.
  - **Dynamic Trial Calculation**: Queries existing subscription state to determine if a user is eligible for a new trial (`trial_period_days`), has a remaining trial balance to honor (`trial_end`), or has expired eligibility (immediate charge).
  - **Session Construction**: Generates a Stripe Checkout session with strictly mapped `clerkId` metadata and line items derived from a centralized `PRICES` configuration.

### Key Dependencies

- **`@clerk/nextjs`**: Manages server-side authentication and provides the JWT templates required for authorized Convex client operations.
- **`convex/browser`**: Provides the `ConvexHttpClient` used to perform server-to-server mutations and queries outside of the standard React hooks context.
- **`stripe`**: The official SDK used for constructing the hosted checkout session and managing customer/subscription objects.
- **`@/lib/api/withObservability`**: A custom utility for request ID tracking and structured error logging.

### Important Gotchas

- **Trial Timing Constraints**: Stripe enforces a rule where `trial_end` must be at least 48 hours in the future. The logic includes a `MIN_TRIAL_MS` check; if a user's remaining trial is less than two days, the system may default to immediate billing or a standard trial depending on state.
- **Webhook Token Circuit Breaker**: The route will return a 503 Service Unavailable if the `CONVEX_WEBHOOK_TOKEN` is missing or if the preflight assertion fails. This prevents users from paying for services that the backend isn't currently configured to acknowledge via webhooks.
- **Metadata Dependency**: The logic injects a `clerkId` into both the Stripe Session and the Subscription metadata. Downstream synchronization logic relies entirely on these metadata fields to link Stripe events back to the correct application user.
- **Fixed Mode**: The handler is hardcoded to `mode: "subscription"`. It cannot be used for one-time credits or product purchases without modification to the session configuration logic.
