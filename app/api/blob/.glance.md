The `/app/api/blob` directory serves as the server-side orchestration layer for secure, client-side file uploads to Vercel Blob storage. It implements a token-based handshake architecture that allows large binary data to be streamed directly from the client to the storage provider, bypassing the application server while maintaining strict administrative control over authentication, metadata, and resource constraints.

### Architecture

The directory follows the Next.js App Router pattern, exposing specialized API routes that utilize the Vercel Blob "Client-side upload" flow. The architecture is designed as a coordinator:

1.  **Authorization:** The server validates the user's session and subscription entitlements.
2.  **Token Issuance:** The server generates a short-lived, scoped upload token containing specific metadata (e.g., `userId`).
3.  **Lifecycle Management:** The server defines constraints (file types, size limits) and handles post-upload hooks to log successful persistence.

### Key File Roles

The directory is segmented into functional sub-endpoints (such as image and audio processing), each containing:

- **`route.ts`**: The primary controller implementing the `POST` handler. It uses the `handleUpload` utility from the Vercel Blob SDK to manage the upload lifecycle.
  - **Image Handler**: Restricts uploads to specific MIME types (`image/jpeg`, `image/png`, `image/webp`) and enforces a 5MB size limit.
  - **Audio Handler**: Manages "listening session" uploads, enforcing business-level logic such as subscription tier validation and rate limiting (e.g., 30 uploads per 24-hour window).
  - **Hooks**: Implements `onBeforeGenerateToken` for security validation and `onUploadCompleted` for server-side telemetry.
- **`route.test.ts`**: A Vitest-based testing suite that mocks Clerk authentication, the Vercel Blob client, and internal entitlement services to verify status code responses (400, 401, 402, 500) and lifecycle execution.

### Dependencies and Gotchas

- **Core Dependencies**: The implementation relies on `@vercel/blob` for the storage protocol, `@clerk/nextjs` for identity management, and internal wrappers (`@/lib/api/withObservability`, `@/lib/sentry`) for telemetry.
- **Storage Configuration**: `addRandomSuffix: true` is enabled by default to prevent filename collisions and unintentional overwrites in the storage bucket.
- **Entitlement Blocking**: The audio upload path is strictly gated by a `requireListeningSessionEntitlement` service; failure to meet subscription or rate-limit criteria results in immediate rejection before the storage handshake begins.
- **Testing Complexity**: Because the Vercel Blob and Entitlement modules are often initialized at the top level, unit tests must utilize `vi.hoisted` to mock these dependencies before module evaluation.
- **Observability Middleware**: The `withObservability` higher-order function wraps the handlers, requiring specific handling in test environments to ensure assertions are made against the underlying response logic rather than the logging wrapper.
