This directory implements the backend infrastructure for handling audio uploads within the "listening sessions" feature. Its primary purpose is to provide a secure, authenticated endpoint that accepts audio streams, validates them against business constraints, persists the binary data to cloud storage, and updates the session state in the database.

### Architecture

The directory follows the Next.js App Router API convention, utilizing an asynchronous request/response lifecycle integrated with several distributed services. The architecture emphasizes a "fail-fast" validation pipeline: it sequentially verifies authentication, rate-limit entitlements, MIME-type compatibility, and database state readiness before initiating expensive storage operations. It employs a higher-order function wrapper, `withObservability`, to inject telemetry and logging into the request execution.

### Key File Roles

- **`route.ts`**: The core implementation of the `POST` handler. It orchestrates the flow between Clerk (authentication), Vercel Blob (binary storage), and Convex (application state). It performs manual header parsing for metadata (e.g., duration and transcript flags) and handles the transition of a session from a `recording` state to a `transcribing` state.
- **`route.test.ts`**: A Vitest-based test suite that simulates the API environment. It uses comprehensive mocking of external providers to validate edge cases, including unauthorized access, invalid state transitions, payload size violations, and successful multi-step upload flows.

### Important Dependencies and Gotchas

- **Vercel Blob & Convex**: The implementation relies on `@vercel/blob` for storage and `convex/browser` for state management. A critical architectural detail is that session ownership and "recording" status are verified via a Convex query _before_ the Vercel Blob `put` operation to prevent the creation of orphaned storage objects.
- **Next.js 15 Paradigms**: In accordance with Next.js 15 requirements, route parameters (`params`) are treated as a `Promise`, requiring asynchronous resolution within the handler.
- **Header-Dependent Metadata**: The API bypasses standard multipart form-data in favor of custom headers (e.g., `x-content-type`, `x-duration-ms`, `x-cap-reached`). Failure to provide these headers results in a `400 Bad Request`.
- **Storage Visibility**: While Vercel Blob is configured with `access: "public"`, security is maintained through opaque path naming (combining session IDs and timestamps) and by routing all subsequent audio access through an authenticated proxy endpoint rather than exposing raw URLs to the client.
- **Payload Constraints**: The handler enforces a strict maximum file size defined by `MAX_LISTENING_SESSION_AUDIO_BYTES` and restricts uploads to a specific set of audio MIME types (WebM, WAV, MPEG, etc.) to ensure compatibility with downstream transcription services.
