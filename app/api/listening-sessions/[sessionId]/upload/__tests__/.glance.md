This directory contains the automated test suite for the listening session audio upload API endpoint. Its primary purpose is to validate the `POST` handler's ability to process audio streams, enforce business logic constraints, and coordinate data between authentication, storage, and database providers.

### Architecture

The testing architecture employs **Vitest** to execute unit and integration tests against a Next.js App Router API route. It follows a mock-heavy strategy to isolate the route logic from its distributed dependencies. The suite simulates the request/response lifecycle by constructing `Request` objects and asserting against `Response` outputs and mock call signatures.

### Key File Roles

- **`route.test.ts`**: This is the primary test specification file. It implements a comprehensive battery of tests covering:
  - **Authentication & Authorization**: Validating Clerk-based identity checks and internal entitlement logic (rate limiting and plan-based access).
  - **Input Validation**: Enforcing constraints on audio payload size (via `MAX_LISTENING_SESSION_AUDIO_BYTES`), mime-types, and the presence of required custom headers.
  - **State Machine Verification**: Ensuring the API correctly interacts with the **Convex** backend to verify that a session is in the "recording" state before permitting an upload.
  - **Storage Integration**: Verifying that valid audio data is correctly piped to **Vercel Blob** storage.
  - **Metadata Handling**: Testing the extraction and persistence of session metadata provided via custom headers like `x-duration-ms`, `x-cap-reached`, and `x-transcript-live`.

### Important Dependencies and Gotchas

- **Vercel Blob & Convex**: The suite relies on sophisticated mocks for `@vercel/blob` and `convex/browser`. Specifically, `vi.hoisted` is used to manage the lifecycle of these mocks before they are imported by the route handler.
- **Environment Configuration**: The tests manually manipulate `process.env.NEXT_PUBLIC_CONVEX_URL` to satisfy the initialization requirements of the Convex client, requiring careful cleanup in `afterEach` blocks to prevent test leakage.
- **Header-Based Logic**: The API relies on `x-content-type` and other `x-` prefixed headers for metadata. Tests must explicitly provide these to avoid 400 Bad Request responses.
- **Observability Bypass**: The `withObservability` higher-order function is mocked to return the raw handler, simplifying the call stack for testing while ensuring that telemetry logic does not interfere with assertions.
- **Asynchronous Params**: In alignment with Next.js 15+ conventions, the route parameters are handled as Promises within the test request context.
