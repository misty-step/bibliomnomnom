This directory serves as the centralized API interface for managing the lifecycle of audio data associated with specific listening sessions. It functions as a secure gateway for both the ingestion (uploading) and egress (streaming) of binary content, acting as a protected intermediary between the client, the application database, and cloud storage providers.

### Architecture

The directory follows the Next.js App Router API pattern, implementing a multi-modal request handler that integrates identity management, state validation, and network proxying. The architecture is built on a "zero-trust" and "fail-fast" philosophy:

- **Ingestion (POST)**: Validates session state and user entitlements before persisting raw audio to Vercel Blob and transitioning session status in Convex.
- **Egress (GET)**: Acts as an authenticated proxy that verifies resource ownership and streams data from storage to the client, supporting native browser media features.
- **Telemetry**: All operations are wrapped in a custom observability layer (`withObservability`) for logging and error tracking via Sentry.

### Key File Roles

- **`route.ts`**: The primary controller for session-specific audio operations.
  - **GET Handler**: Implements a secure audio proxy. It retrieves session metadata from Convex, validates the user's Clerk identity, enforces a trusted host policy for URLs, and pipes the binary stream from the upstream provider to the client.
  - **POST Handler**: Manages audio uploads. It enforces file size and MIME-type constraints, handles binary persistence to Vercel Blob, and updates the session's state (e.g., moving from `recording` to `transcribing`).
- **`route.test.ts`**: A Vitest-based suite that ensures the integrity of the API. It utilizes extensive mocking of Clerk, Convex, and Vercel Blob to validate security boundaries, state transition logic, and error handling for malformed requests.

### Important Dependencies

- **Clerk (`@clerk/nextjs/server`)**: Essential for session-based authentication and generating JWT templates for service-to-service communication.
- **Convex (`convex/browser`)**: Used via `ConvexHttpClient` for server-side database lookups and state mutations.
- **Vercel Blob (`@vercel/blob`)**: The primary storage engine for raw audio files.
- **Security Utilities**: Local dependencies like `isTrustedAudioHost` are used to mitigate SSRF (Server-Side Request Forgery) risks during proxying.

### Gotchas

- **HTTP Range Requests**: For the GET proxy, the implementation must manually forward and preserve `Range`, `Content-Range`, and `206 Partial Content` headers. Failure to do so breaks the browser's ability to seek (scrub) through audio files.
- **Next.js 15 Async Params**: Route parameters (`params`) are treated as a `Promise` and must be resolved asynchronously within the handlers.
- **Header-Based Metadata**: The upload logic relies on custom headers (e.g., `x-duration-ms`, `x-content-type`) rather than standard multipart form-data; missing headers will result in a `400 Bad Request`.
- **Environment Variables**: The logic is strictly dependent on `NEXT_PUBLIC_CONVEX_URL`. If this is missing, the API returns a `503 Service Unavailable`.
- **Stream Integrity**: The proxy uses `ReadableStream` to pipe data directly, preventing high memory overhead on the server when handling large audio files.
