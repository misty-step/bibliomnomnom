This directory provides a serverless API endpoint for converting stored audio into text within the "listening sessions" feature of the application. The architecture follows a Next.js Route Handler pattern, acting as an orchestrator between identity management, database state, and external Speech-to-Text (STT) providers.

### Purpose and Architecture

The primary purpose of this directory is to expose a `POST` endpoint that processes audio transcription requests. The logic is structured as an orchestrated pipeline:

1.  **Identity & Authorization**: Validates the user session via Clerk.
2.  **Input Validation**: Ensures the request contains a valid Convex `sessionId` and rejects deprecated fields like `audioUrl`.
3.  **Entitlement Enforcement**: Verifies the user's subscription status and enforces a 24-hour rate limit (30 sessions) before initiating high-cost STT operations.
4.  **Resource Retrieval**: Queries the Convex database to resolve the session's audio storage location (typically Vercel Blob).
5.  **Provider Orchestration**: Coordinates the transcription through an abstraction layer that attempts ElevenLabs first, falling back to Deepgram if necessary.
6.  **Telemetry & State Management**: Records latency and provider usage to the database and updates the session status to a "failed" state in the event of an error.

### Key File Roles

- **`route.ts`**: The main entry point. It implements the `POST` handler wrapped in observability middleware. It manages the request-response lifecycle, environment variable verification for API keys, and error handling for the transcription pipeline.
- **`route.test.ts` (referenced in subdirectories)**: An integration test suite using Vitest. It stubs global fetch calls and mocks the Convex and Clerk environments to validate edge cases such as provider failover, 402 Payment Required status for expired entitlements, and 413 Payload Too Large for oversized audio files.

### Key Dependencies

- **Clerk**: Handles authentication and user identity.
- **Convex**: Manages session state, retrieves audio URLs, and stores telemetry data via mutations.
- **STT Providers**: Integrates with ElevenLabs and Deepgram for audio processing.
- **withObservability**: A higher-order function used to wrap the route for standardized logging and request tracking.

### Important Gotchas

- **Timeout Configuration**: The `maxDuration` is explicitly set to 60 seconds to accommodate the cumulative latency of fetching audio and potentially calling two different STT providers in a failover scenario.
- **Failover Logic**: The implementation contains a hardcoded preference for ElevenLabs, using Deepgram as a secondary fallback. Telemetry specifically tracks when this fallback occurs.
- **State Side Effects**: If transcription fails, the route performs a mutation to mark the session as failed at the `transcribing` stage, ensuring the UI reflects the pipeline break.
- **Environment Variables**: The route requires `DEEPGRAM_API_KEY` or `ELEVENLABS_API_KEY` to be configured; if both are missing, the endpoint returns a 500 Internal Server Error.
