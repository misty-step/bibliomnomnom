This directory contains the test suite for the listening sessions transcription API, specifically targeting the `POST` handler responsible for converting audio files into text. The tests are implemented using Vitest and focus on validating the orchestration between authentication, entitlement verification, external storage retrieval, and Speech-to-Text (STT) provider integration.

### Architecture and Key File Roles

The primary file, `route.test.ts`, serves as an integration test for the transcription route. It simulates the request-response lifecycle by mocking the Next.js request environment and internal library dependencies. The architecture follows a behavioral testing pattern, ensuring the route handles various edge cases including authentication failures, payload validation, and service-level fallbacks.

Key responsibilities tested include:

- **Authentication and Authorization:** Mocking `@clerk/nextjs/server` to simulate authenticated and unauthenticated states.
- **Entitlement Enforcement:** Utilizing a hoisted mock for `requireListeningSessionEntitlement` to verify that users have the necessary subscription status (returning 402 on failure) before processing audio.
- **Input Validation:** Ensuring the API rejects malformed JSON, missing `sessionId` parameters, or legacy `audioUrl` fields with 400-series status codes.
- **Provider Orchestration:** Testing the logic that selects between STT providers. A significant portion of the logic validates a failover mechanism where the system attempts to use ElevenLabs first and falls back to Deepgram if the primary service is unavailable or unconfigured.
- **Resource Constraints:** Enforcing file size limits by checking against `MAX_LISTENING_SESSION_AUDIO_BYTES` and returning a 413 Payload Too Large status when exceeded.

### Key Dependencies

- **Vitest:** The core testing framework used for assertions, mocking, and global environment stubbing.
- **Clerk:** Used for identity management; mocked to control user session context.
- **Convex:** Mocked via the entitlement library to simulate database queries that retrieve audio URLs from Vercel Blob storage.
- **Global Fetch API:** Stubbed using `vi.stubGlobal` to simulate network interactions with Vercel Blob storage and external STT APIs (Deepgram and ElevenLabs).

### Important Gotchas

- **Environment Variable Management:** The tests manually manipulate `process.env.DEEPGRAM_API_KEY` and `process.env.ELEVENLABS_API_KEY` to test configuration-dependent logic. These are cached and restored in the `afterEach` hook to prevent state leakage between tests.
- **Hoisted Mocks:** The entitlement and database mocks use `vi.hoisted` to ensure they are initialized before the module imports, which is necessary for mocking internal library dependencies in Vitest.
- **Observability Wrapper:** The `withObservability` higher-order function is mocked to return the handler directly, bypassing telemetry logic to focus strictly on the functional business logic of the route.
