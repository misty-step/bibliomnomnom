### Technical Overview: /api/listening-sessions

This directory serves as the centralized backend orchestration layer for the "listening sessions" feature, managing the complete lifecycle of audio data from raw binary ingestion to speech-to-text transcription and AI-driven synthesis of literary insights. It acts as a secure intermediary between the client-side application, the Convex database, and various third-party infrastructure providers including Vercel Blob, ElevenLabs, Deepgram, and OpenRouter.

### Architecture

The directory follows a modular Next.js App Router API pattern, where each subdirectory represents a specific stage in the data processing pipeline. The architecture is designed for high availability and graceful degradation:

- **Data Proxying & Persistence**: The root handlers manage the secure upload and authenticated streaming of audio files, utilizing a proxy pattern to enforce security boundaries and support native browser media features like seeking.
- **Orchestration Pipeline**: The system implements a linear state machine (Recording → Transcribing → Synthesizing) where each endpoint validates the current state in Convex before proceeding to the next high-cost operation.
- **Resiliency Layer**: Both transcription and synthesis modules include failover logic, such as provider switching (ElevenLabs to Deepgram) or "degraded mode" fallbacks, ensuring the API remains responsive even when third-party AI services fail.

### Key File Roles

- **`route.ts` (Root)**: Manages the binary audio interface. The `POST` handler persists raw audio to Vercel Blob and updates session state, while the `GET` handler acts as an authenticated proxy, piping streams from storage to the client with support for `Range` headers.
- **`synthesize/route.ts`**: An LLM orchestration endpoint that transforms transcripts into structured JSON artifacts (insights, quotes). It performs context augmentation by fetching book metadata from Convex and enforces schema-validated responses via OpenRouter.
- **`transcribe/route.ts`**: A Speech-to-Text (STT) controller that retrieves stored audio and coordinates transcription. It manages provider failover logic and records performance telemetry (latency and cost) back to the database.
- **`*.test.ts`**: Vitest suites across the directory that utilize extensive mocking of external service boundaries (Clerk, Convex, and AI providers) to validate security guards, rate limiting, and error-handling paths.

### Important Dependencies

- **Convex (`convex/browser`)**: The source of truth for session state, book context, and telemetry logging.
- **Clerk (`@clerk/nextjs/server`)**: Provides identity management and entitlement verification for subscription-gated features.
- **Vercel Blob (`@vercel/blob`)**: The primary object storage for audio assets.
- **AI Providers**: OpenRouter (LLM synthesis), ElevenLabs, and Deepgram (STT) are integrated for core processing.
- **Observability**: A custom `withObservability` wrapper is applied to all routes for standardized logging and Sentry error tracking.

### Gotchas

- **HTTP Range Requests**: The audio proxy in the root `route.ts` must manually forward `Range` and `Content-Range` headers; omitting these prevents users from scrubbing or seeking through audio in the browser.
- **Next.js 15 Async Params**: Route parameters are treated as Promises and must be awaited, a requirement for compatibility with the Next.js 15 runtime.
- **Transcript Truncation**: The synthesis engine silently clamps transcripts at a maximum character limit (`MAX_SYNTHESIS_TRANSCRIPT_CHARS`) to prevent context window overflows and manage LLM costs.
- **Timeout Constraints**: The transcription endpoint is configured with a `maxDuration` of 60 seconds to accommodate the cumulative latency of file retrieval and secondary STT provider failover.
- **Degraded Mode**: The synthesis API is designed to return "fallback" artifacts rather than a 500 error if the LLM provider is unavailable, requiring the frontend to handle a `degradedMode` flag.
- **Header-Based Metadata**: Audio uploads rely on custom headers (e.g., `x-duration-ms`) for metadata persistence; requests missing these headers are rejected with a 400 Bad Request.
