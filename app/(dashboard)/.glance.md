The `/app/(dashboard)` directory serves as the primary authenticated application shell for Bibliomnomnom. It is structured as a Next.js route group, providing a unified layout and shared logic for the core user experience—including library management, data ingestion, profile settings, and subscription billing—without affecting the URL structure.

### Architecture and Layout

The directory utilizes a centralized layout pattern where global state, authentication, and access control are enforced at the top level, while specific domain logic is delegated to nested route segments.

- **`layout.tsx`**: Acts as the dashboard's primary gatekeeper. This Server Component performs mandatory authentication checks via Clerk, redirecting unauthenticated users to the sign-in flow. It establishes the global UI framework, including a `Masthead` for navigation and a `TrialBanner` for subscription awareness. Crucially, it wraps all dashboard content in a `SubscriptionGate` to enforce feature access and a `FadeInContent` wrapper for transition aesthetics. It also initializes `CheckoutReturnSync` to handle post-payment state updates.

### Sub-route Roles

- **`/import`**: A client-side workflow for data ingestion. It utilizes a state machine (`ImportFlow`) to manage file uploads and bibliographic parsing within a wide-screen, multi-step interface.
- **`/library`**: The core resource management module. It employs a hybrid rendering strategy: a Client Component for the searchable/sortable aggregate library view and Server Components for individual book resource resolution within the `[id]` dynamic segment.
- **`/profile`**: A declarative interface for user identity management. It relies on `ErrorBoundary` and `Suspense` wrappers to isolate data-fetching failures and provide smooth loading states for profile-specific components.
- **`/settings`**: Manages the commercial relationship with the user. It bridges server-side environment variables (Stripe price IDs) with client-side state to display billing cycles, plan statuses, and facilitate redirects to the Stripe Customer Portal.

### Key Dependencies

- **Clerk Auth**: Handles server-side session validation and user metadata retrieval.
- **Convex**: The primary data layer, used for real-time library synchronization and subscription status tracking via the `useQuery` hook.
- **Stripe**: Integrated via local API routes for billing management and session generation.
- **Sentry**: Utilized within error boundaries (specifically in `/settings`) for automated error reporting and telemetry.
- **Lucide React**: Provides the iconographic language across all dashboard modules.

### Technical Gotchas

- **Subscription Gating**: Because the `SubscriptionGate` is implemented in the root `layout.tsx`, all child routes (import, library, profile, settings) are subject to global subscription logic, which may restrict access based on billing state.
- **Client/Server Hybridity**: The directory mixes Server Components (for layout and dynamic routing) with Client Components (for interactive views like the library list and settings). This requires careful synchronization of loading states to prevent UI flickering.
- **Loading State Redundancy**: In segments like `/library`, loading states are defined both in `loading.tsx` and via internal `Suspense` fallbacks, necessitating visual parity between these implementations.
- **Manual Type Casting**: The dynamic `[id]` route segments perform manual type assertions (e.g., `as Id<"books">`) on URL parameters, shifting the responsibility for invalid ID handling to downstream error boundaries.
