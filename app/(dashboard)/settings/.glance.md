### Technical Overview: /app/(dashboard)/settings

This directory implements the user account and subscription management interface. It provides a centralized dashboard for users to view their current plan status, monitor billing cycles, and access the Stripe customer portal for payment modifications.

#### Architecture and Logic Flow

The directory follows a standard Next.js App Router pattern, separating server-side environment injection from client-side state management and interactivity:

- **Data Fetching:** Subscription data is synchronized in real-time using Convex via the `useQuery` hook.
- **State Management:** The UI dynamically transitions between loading, empty (no subscription), trialing, active, and canceling states based on the subscription's metadata.
- **Stripe Integration:** Billing management is handled through an external redirect. The application communicates with a local API route (`/api/stripe/portal`) to generate a secure Stripe Billing Portal session.
- **Error Handling:** A dedicated error boundary captures routing or rendering failures, logging them to Sentry with specific error digests and route tags.

#### Key File Roles

- **`page.tsx`**: The server-side entry point. It retrieves Stripe price IDs from environment variables (`STRIPE_PRICE_MONTHLY`, `STRIPE_PRICE_ANNUAL`) and passes them as props to the client component, ensuring sensitive configuration remains on the server.
- **`SettingsPageClient.tsx`**: The primary functional component. It contains the logic for formatting billing dates, determining subscription status labels (e.g., "Access Until" for canceling users), and managing the asynchronous state of the billing portal request.
- **`SettingsPageClient.test.tsx`**: A comprehensive Vitest suite that mocks Convex queries and global fetch calls to verify UI consistency across different subscription statuses (active, trialing, expired) and error scenarios.
- **`loading.tsx`**: Provides a skeleton UI using Tailwind pulse animations and a `Loader2` spinner to maintain visual stability during the initial Convex data fetch.
- **`error.tsx`**: A client-side error boundary that utilizes the `captureError` utility to report failures to Sentry while providing the user with a retry mechanism.

#### Key Dependencies and Gotchas

- **Convex (`convex/react`)**: Essential for the `useQuery` hook. The component expects a `subscriptions.get` API endpoint to return a specific schema including `status`, `cancelAtPeriodEnd`, and `currentPeriodEnd`.
- **Stripe Configuration**: The application relies on `STRIPE_PRICE_MONTHLY` and `STRIPE_PRICE_ANNUAL` environment variables. If these are missing or mismatched with the database price IDs, the `getPlanNameFromPriceId` utility may return "Unknown" or "Free" labels.
- **External Redirects**: The `redirectTo` utility is used for the Stripe portal; this bypasses standard Next.js client-side routing to handle external URL transitions.
- **Sentry**: Integrated via `@/lib/sentry` for automated error reporting in both the error boundary and the billing portal fetch logic.
- **UI Components**: Heavily dependent on local shared components including `Surface`, `PageContainer`, and `EmptyState` for layout and design consistency.
