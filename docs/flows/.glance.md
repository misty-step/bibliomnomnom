### Technical Overview: /docs/flows

This directory serves as the central documentation hub for the complex state machines, asynchronous data pipelines, and multi-step UI flows within the bibliomnomnom application. It utilizes Mermaid diagrams and detailed state definitions to map front-end component logic to back-end services, providing a blueprint for handling race conditions, error recovery, and long-running processes.

#### Architecture and Key File Roles

The directory is organized by functional domain, with each file corresponding to specific React components or backend service orchestrations:

- **Data Ingestion and Management**:
  - `import-flow.md`: Documents the application's most complex state machine, covering file parsing (CSV/MD), LLM-based extraction, deduplication logic, and batched commits via `useImportJob.ts`.
  - `add-book-sheet.md`: Maps the 15+ state variables and multi-source data entry (manual vs. API) for the core book tracking form.
  - `book-cover-manager.md`: Details the orchestration between Vercel Blob storage, external APIs (Open Library/Google Books), and local file uploads for cover art.

- **AI and Media Processing**:
  - `listening-sessions.md`: Outlines a multi-stage pipeline—Record (MediaRecorder), Upload (Vercel Blob), Transcribe (ElevenLabs/Deepgram), Synthesize (OpenRouter/LLM), and Persist (Convex)—for voice-based note-taking.
  - `photo-quote-capture.md`: Defines the state machine for camera-based OCR, including image transcoding and timeout management.
  - `profile-generation.md`: Manages the long-running async generation of AI user profiles based on library statistics and reading habits.

- **System Lifecycle and Infrastructure**:
  - `stripe-subscription.md`: Visualizes the payment lifecycle, including trial states, webhook idempotency, and the 7-day grace period for failed payments.
  - `user-provisioning.md`: Addresses the critical first-login race condition between Clerk authentication and Convex user record creation.
  - `subscription-banner.md`: Governs the conditional rendering logic for trial and expiration UI based on subscription status.

#### Key Dependencies

The flows documented here rely on a tightly integrated stack of external services and internal frameworks:

- **Database/Backend**: Convex (mutations, queries, and background jobs).
- **Storage**: Vercel Blob (presigned URLs for audio and images).
- **AI/ML**: OpenRouter (LLM synthesis), ElevenLabs/Deepgram (STT), and custom OCR endpoints.
- **Payments/Auth**: Stripe (subscriptions and webhooks) and Clerk (identity management).

#### Technical Gotchas and Implementation Details

- **Race Conditions**: The `user-provisioning` flow uses a dedicated `UserProvisioningProvider` to block queries until the `ensureUser` mutation confirms the user record exists, preventing "User not found" errors on first login.
- **Idempotency**: The Stripe integration implements a `webhookEvents` table in Convex to check for previously processed event IDs, ensuring payment events are not handled multiple times.
- **State Reset**: The `AddBookSheet` component requires a manual reset of over 15 state variables upon closure to prevent data leakage between subsequent entries.
- **Lazy Preparation**: The `import-flow` utilizes a `preparedPages` tracking array and a `preparePageInFlight` ref to prevent redundant API calls during paginated CSV previews.
- **Timeouts and Limits**: OCR processing includes a hard 35-second timeout, while listening sessions include logic for forced rollovers and audio codec normalization to ensure server-side compatibility.
- **Access Control**: Subscription access is determined by a complex union of `trialing`, `active`, `past_due`, and `canceled` statuses, with specific logic for period-end expiration.
