The `/Users/phaedrus/Development/bibliomnomnom/docs/investigations` directory serves as a centralized repository for technical post-mortems, incident reports, and root cause analyses (RCA). The directory is structured to document critical production failures, the state of the system during those failures, and the specific manual interventions required to restore data integrity.

### Architecture and Data Flow

The investigations primarily focus on the synchronization logic between three distinct architectural layers:

- **External Infrastructure (Stripe):** The source of truth for financial transactions and subscription lifecycles.
- **Edge/Middleware (Vercel):** The ingestion point for webhooks and the host for environment-specific secrets.
- **Backend-as-a-Service (Convex):** The reactive database and execution engine that stores user subscription states and processes business logic via Convex Actions.

The system architecture relies on asynchronous webhook delivery to maintain state consistency across these platforms. Documentation within this directory highlights the fragility of this pipeline, particularly regarding the validation of `CONVEX_WEBHOOK_TOKEN` during the handoff from Vercel to Convex.

### Key File Roles

Files within this directory, such as `2026-01-17-trial-banner-bug.md`, function as structured incident logs. They typically contain:

- **Contextual Metadata:** Timestamps, severity levels, and specific user identifiers (Clerk IDs, Stripe Customer IDs) involved in the incident.
- **Root Cause Analysis:** Detailed breakdowns of configuration drift, such as misaligned webhook URLs or corrupted environment variables.
- **Remediation Logs:** Precise CLI commands used for manual data synchronization (e.g., `npx convex run --prod subscriptions:upsertFromWebhook`) and environment variable correction.

### Important Dependencies and Gotchas

- **CLI Environment Context:** A recurring technical hurdle documented is the ambiguity of the Convex CLI environment. The CLI may default to development deployments even when `CONVEX_DEPLOYMENT` variables are set, making the `--prod` flag a critical dependency for accurate production data inspection.
- **Environment Variable Sanitization:** The system is sensitive to the formatting of secrets within the Vercel and Convex dashboards. Trailing newlines (`\n`) in tokens can lead to silent authentication failures in webhook validation logic.
- **Webhook Routing:** The architecture requires exact parity between the domain configured in the Stripe Dashboard and the active production URL; misconfigurations here result in a total failure of the subscription synchronization pipeline.
- **Environment Parity:** The documentation emphasizes that `CONVEX_WEBHOOK_TOKEN` must be manually synchronized across both Vercel (for sending) and Convex (for receiving/validating), as there is no automated propagation of secrets between these two distinct cloud providers.
