This directory serves as the central repository for Architecture Decision Records (ADRs) for the bibliomnomnom project, documenting the evolution of its serverless, real-time architecture. The system is built primarily on **Convex** (backend), **Next.js** (frontend), and **Bun** (package management), with external integrations for **Clerk** (auth), **Stripe** (billing), and **OpenRouter** (LLM services).

### Architecture and Design Patterns

The architecture emphasizes resilience in serverless environments and strict separation of concerns:

- **State Machine Logic:** Complex asynchronous workflows, such as audio processing in "Listening Sessions," are managed via a server-side state machine (`idle → recording → uploading → transcribing → synthesizing → complete`) to ensure reliability across client disconnects (ADR-0013).
- **Repository Pattern:** The import system utilizes an abstraction layer (ADR-0004) to decouple business logic from the Convex database, enabling unit testing via in-memory mocks.
- **Action/Mutation Split:** Non-deterministic side effects, specifically LLM extractions and API calls, are isolated within Convex Actions, which then pass validated data to Mutations for atomic persistence (ADR-0005).
- **Layered Privacy:** To compensate for the public-by-default nature of Vercel Blob storage, the system implements a defense-in-depth strategy including server-side uploads, projection stripping in queries, and auth-gated proxies for playback (ADR-0012).

### Key File Roles

- **Auth & Provisioning (0001, 0007):** Manages a dual-provisioning flow using Clerk webhooks for eager creation and lazy-loading in mutations as a fallback to prevent race conditions. A custom adapter ensures SSR compatibility with Next.js.
- **Billing & Subscriptions (0002, 0008, 0010):** Implements internal trial tracking to minimize Stripe object bloat, simplifies Stripe's complex subscription statuses into five internal states, and enforces a 7-day grace period for `past_due` accounts.
- **AI & Context Management (0006, 0014):** Defines fallback logic for LLM providers via OpenRouter and implements a token-budgeted context packer to prioritize relevant book data while maintaining cost bounds.
- **Reliability (0009, 0011):** Establishes a "earliest-wins" de-duplication pattern for database inserts and a Convex-backed distributed rate limiter to handle requests across ephemeral Vercel instances.

### Important Dependencies and Gotchas

- **Convex:** Central to data persistence and distributed coordination. A recurring "gotcha" is the lack of unique constraints, requiring the manual de-duplication patterns documented in ADR-0009.
- **Clerk & Next.js:** Integration requires a custom `useAuth` wrapper to handle hydration issues specific to Next.js 16 (ADR-0007).
- **Stripe Webhooks:** Secured via a secondary shared token (`CONVEX_WEBHOOK_TOKEN`) because Convex public actions are accessible via deployment URLs (ADR-0003).
- **Vercel Blob:** Used for audio storage but lacks per-blob private access, necessitating the proxy architecture defined in ADR-0012.
- **Bun:** Enforced as the sole package manager via `preinstall` scripts to ensure consistent 1.2.x environments across development and CI (ADR-0015).
