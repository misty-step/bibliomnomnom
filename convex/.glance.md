The `/convex` directory serves as the backend-as-a-service layer for the "bibliomnomnom" application. It leverages the Convex platform to provide a reactive, type-safe document database, serverless function execution, and real-time data synchronization. The architecture is built around a centralized schema and a strictly enforced ownership-based security model.

### Architecture and Purpose

The backend follows a functional, event-driven architecture categorized into three primary execution environments:

- **Queries and Mutations**: Deterministic, transactional operations that interact directly with the database. These are used for CRUD operations on books, notes, and user profiles, ensuring data consistency and atomic updates.
- **Actions**: Non-deterministic environments capable of performing side effects, such as calling external APIs (OpenRouter, Deepgram, Stripe) or performing long-running AI synthesis.
- **HTTP Actions and Crons**: Entry points for external webhooks (Clerk, Stripe) and scheduled maintenance tasks like recovering stuck sessions or cleaning up stale rate-limit logs.

### Key File Roles

- **`schema.ts`**: The central source of truth for the database. It defines the structure, relational links (via `v.id`), and indexes for ten tables, including `users`, `books`, `listeningSessions`, and `readerProfiles`.
- **`auth.ts` and `auth.config.ts`**: Implements the authentication bridge between Clerk and Convex. It provides the `requireAuth` helper, which is mandated across all mutations to enforce row-level security by deriving the `userId` from verified JWT identities.
- **`books.ts` and `notes.ts`**: Contain the core business logic for library management. These modules implement privacy filtering (ensuring users only see their own or public data) and automatic state management (e.g., updating reading dates when a book's status changes).
- **`listeningSessions.ts`**: Manages a complex, multi-stage state machine (`recording` → `transcribing` → `synthesizing` → `complete`) for processing audio reading notes. It handles context packing for LLM synthesis and tracks estimated API costs.
- **`profiles.ts`**: Orchestrates the generation of AI-driven "Reader Profiles." It includes logic for computing reading statistics and managing the lifecycle of cached AI insights.
- **`subscriptions.ts`**: The internal authority for user entitlements. It maps Stripe subscription states to application access levels and implements a 7-day grace period for `past_due` accounts.
- **`imports.ts`**: Implements a two-phase commit pattern (preview → commit) for bulk data ingestion, supporting structured CSVs and unstructured text via LLM extraction.
- **`rateLimit.ts` and `webhookEvents.ts`**: Provide infrastructure-level utilities for distributed rate limiting and webhook idempotency using the database as a backing store.

### Subdirectory Summaries

- **`_generated/`**: The type-safe integration layer. It contains the auto-generated TypeScript definitions and function builders that synchronize the schema with the application logic.
- **`actions/`**: The integration layer for heavy-compute and external service orchestration, specifically handling AI content synthesis, federated book search, and media proxying.
- **`stripe/`**: The gateway for payment infrastructure, managing outbound checkout sessions and inbound webhook processing for subscription synchronization.

### Important Dependencies and Gotchas

- **Deterministic Constraint**: Mutations and Queries must be deterministic. Any logic requiring external network calls (e.g., fetching book covers or LLM completions) must be isolated within Actions.
- **Lazy User Creation**: The system uses a "lazy" creation pattern where user records are initialized upon their first authenticated mutation if they do not yet exist in the database.
- **Webhook Security**: Inbound webhooks from Stripe and Clerk require specific environment variables (`STRIPE_WEBHOOK_SECRET`, `CONVEX_WEBHOOK_TOKEN`) for signature and token verification. Failure to synchronize these between Vercel and Convex will result in synchronization failures.
- **Environment Variables**: Core functionality is dependent on several external provider keys, including `OPENROUTER_API_KEY`, `CLERK_JWT_ISSUER_DOMAIN`, and `STRIPE_KEY`.
- **CLI Dependency**: The `_generated` directory is volatile; manual changes are overwritten by the Convex CLI during `npx convex dev` or `codegen`.
