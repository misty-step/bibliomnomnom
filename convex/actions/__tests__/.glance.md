This directory serves as the test suite for Convex Actions within the `bibliomnomnom` backend, specifically focusing on the orchestration of asynchronous background tasks. The architecture utilizes **Vitest** for unit and integration testing, employing a dependency-injection pattern to mock the Convex `ActionContext`. This allows for the simulation of database queries, mutations, and scheduled tasks without requiring a live Convex deployment.

### Key File Roles

- **`processListeningSession.test.ts`**: Validates the state machine and processing pipeline for audio listening sessions. It tests the transition logic from transcription to LLM-based synthesis, ensuring that sessions move correctly through `transcribing`, `synthesizing`, and `complete` statuses. It specifically verifies:
  - **Access Control**: Enforcement of user subscription requirements before processing.
  - **External Integration**: Mocking of transcription services (e.g., Deepgram) and LLM providers (via OpenRouter).
  - **Resiliency**: Logic for retries and exponential backoff using the Convex `scheduler`, including terminal failure handling after maximum retry attempts are reached.

### Dependencies and Gotchas

- **Vitest**: The primary testing framework; tests rely on `vi.fn()` for tracking side effects in the Convex runtime.
- **Environment Variables**: The suite manually manages `OPENROUTER_API_KEY`, requiring careful cleanup in `afterEach` blocks to prevent side effects between test cases.
- **Mock Context**: The `MockCtx` implementation simulates the sequential nature of Convex queries by shifting results from an array. This requires test authors to precisely align the order of mocked return values with the execution flow of the handler.
- **Type Casting**: Extensive use of `as any` for session IDs and context objects indicates a trade-off between strict TypeScript compliance and the flexibility needed to mock complex, platform-specific internal types.
