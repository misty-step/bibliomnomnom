This directory contains the Convex Actions for the `bibliomnomnom` backend, serving as the primary layer for non-deterministic operations and external service integrations. The architecture utilizes the Node.js runtime to execute long-running tasks, such as AI-driven content synthesis, federated data retrieval from third-party APIs, and media processing, which are orchestrated through a combination of public and internal actions.

### Key File Roles

- **`processListeningSession.ts`**: Implements an asynchronous state machine for processing audio-based reading notes. It orchestrates a pipeline that transitions sessions through transcription (via Deepgram/ElevenLabs) and LLM-based synthesis (via OpenRouter). It features a robust retry logic using the Convex `scheduler` with exponential backoff and enforces subscription-based access control before consuming external API credits.
- **`profileInsights.ts`**: Generates comprehensive "Reader Profiles" by analyzing a user's library. It uses OpenRouter to derive reader archetypes, thematic connections, and personalized recommendations. The file includes complex logic for fallback models, structured JSON parsing of LLM outputs, and data enrichment to map AI-suggested titles back to the user's existing library metadata and cover art.
- **`bookSearch.ts`**: Provides a client-facing interface for the Open Library Search API. It handles the normalization of external book data into the internal schema, including specialized logic for extracting the "best" ISBN (prioritizing ISBN-13) and constructing cover image URLs from Open Library IDs.
- **`coverFetch.ts`**: Implements a federated search strategy to locate book covers using both Google Books and Open Library. It includes a secure image proxy (`downloadImage`) that converts third-party images to base64 data URLs, enabling the client to bypass CORS restrictions when uploading images to Vercel Blob storage.

### Dependencies and Gotchas

- **External AI Providers**: Relies heavily on OpenRouter for LLM completions. The system uses a specific fallback pattern (`DEFAULT_PROFILE_MODEL` and `PROFILE_FALLBACK_MODELS`) to maintain availability during upstream rate limits or outages.
- **SSRF Protection**: The `downloadImage` action in `coverFetch.ts` utilizes a strict `ALLOWED_COVER_DOMAINS` allowlist to prevent Server-Side Request Forgery when proxying image downloads.
- **Timeout Management**: Due to the latency of LLM and federated search operations, several actions implement custom `AbortSignal` timeouts (ranging from 5s to 120s) to prevent hanging executions within the Convex runtime.
- **Environment Variables**: Functionality is dependent on several keys (`OPENROUTER_API_KEY`, `GOOGLE_BOOKS_API_KEY`, `DEEPGRAM_API_KEY`, `ELEVENLABS_API_KEY`). Missing keys will cause silent failures or logged errors depending on the specific integration.
- **Context Mocking**: As highlighted in the test suite, the actions rely on a dependency-injection pattern for `ActionCtx` (specifically `runQuery` and `runMutation`), requiring careful alignment of mocked return values with the sequential execution of the handlers.
