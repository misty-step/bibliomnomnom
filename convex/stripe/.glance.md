### Technical Overview: /convex/stripe

The `/convex/stripe` directory functions as the integration gateway between the Convex backend and the Stripe payment infrastructure. Its primary purpose is to orchestrate the subscription lifecycle, manage secure checkout sessions, and synchronize external payment states with the application's internal database.

#### Architecture

The directory utilizes a decoupled, event-driven architecture centered around Convex **Actions** and **HTTP Actions**. Because Stripe interactions require external network requests and sensitive cryptographic operations, they are isolated from the deterministic environment of queries and mutations. The flow typically follows a two-part pattern:

1.  **Outbound (User-Triggered):** Convex Actions initiate requests to the Stripe API to generate hosted Checkout or Billing Portal URLs.
2.  **Inbound (Stripe-Triggered):** An HTTP Action acts as a webhook listener, receiving asynchronous event notifications from Stripe to update the system of record via internal mutations.

#### Key File Roles

- **`actions.ts`**: Defines the business logic for interacting with the Stripe SDK. It contains functions to create Checkout sessions for new subscriptions and generates Customer Portal links for existing users to manage their billing. These actions act as the interface between the frontend client and the Stripe REST API.
- **`webhooks.ts`**: Implements the logic for ingesting Stripe webhook events. It is responsible for raw body parsing and signature verification. Once a request is validated, it dispatches internal mutations to update user records, subscription IDs, and entitlement statuses based on events like `checkout.session.completed` or `invoice.payment_succeeded`.

#### Important Dependencies

- **`stripe` SDK**: The official Node.js library used to interact with Stripeâ€™s API resources.
- **Environment Variables**: The module relies on `STRIPE_KEY` for API authentication and `STRIPE_WEBHOOK_SECRET` for validating the authenticity of incoming webhook payloads.

#### Key Gotchas

- **Webhook Signature Verification**: Local development requires the Stripe CLI to forward events to the Convex deployment. The `STRIPE_WEBHOOK_SECRET` must be updated to match the CLI-generated secret for local testing, or the webhook verification will fail.
- **Idempotency and Latency**: Stripe webhooks are asynchronous. There is a inherent delay between a successful payment and the database update in Convex. Logic must account for potential race conditions where a user returns to the app before the webhook mutation has completed.
- **Execution Environment**: Functions in this directory must be defined as Convex Actions (`v.action`) because they perform non-deterministic network requests and utilize the Stripe Node.js library, which is incompatible with the restricted environment of mutations and queries.
