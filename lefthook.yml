# Lefthook Configuration
# Enables Friday afternoon deploy confidence with automated quality gates
# Docs: https://lefthook.dev/

min_version: 2.0.0

pre-commit:
  parallel: true
  commands:
    trufflehog:
      run: |
        if ! command -v trufflehog &> /dev/null; then
          echo "‚ùå TruffleHog not found. Install with:"
          echo "   brew install trufflesecurity/trufflehog/trufflehog"
          echo "   or: https://github.com/trufflesecurity/trufflehog#installation"
          exit 1
        fi
        repo_dir="$(git rev-parse --git-common-dir)"
        trufflehog git --bare "file://$repo_dir" --since-commit HEAD --only-verified --fail --no-update

    lint:
      glob: "**/*.{ts,tsx,js,jsx}"
      run: ./scripts/bun.sh eslint --fix --max-warnings 0 --no-warn-ignored {staged_files}
      stage_fixed: true

    format:
      glob: "**/*.{ts,tsx,js,jsx,json,md,css}"
      run: ./scripts/bun.sh prettier --write {staged_files}
      stage_fixed: true

    typecheck:
      run: ./scripts/bun.sh tsc --noEmit

pre-push:
  parallel: true
  commands:
    env-check:
      # Validates local env vars (presence check)
      run: ./scripts/validate-env.sh

    env-check-prod:
      # Validates production env vars including:
      # - Presence of required vars
      # - Format validation (Stripe key patterns)
      # - Trailing whitespace detection
      # - Parity warning for CONVEX_WEBHOOK_TOKEN
      run: ./scripts/validate-env.sh --prod-only
      skip:
        - merge
        - rebase

    test:
      run: ./scripts/bun.sh test

    build:
      run: ./scripts/bun.sh build:local

commit-msg:
  commands:
    commitlint:
      run: ./scripts/bun.sh commitlint --edit {1}
