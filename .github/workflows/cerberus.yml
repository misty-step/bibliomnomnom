name: Cerberus Council

on:
  pull_request:
    branches: ["master"]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: cerberus-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: misty-step/cerberus/validate@v2.22.1

  matrix:
    needs: validate
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      count: ${{ steps.generate.outputs.count }}
    steps:
      - uses: misty-step/cerberus/matrix@v2.22.1
        id: generate

  review:
    needs: matrix
    if: github.event.pull_request.head.repo.full_name == github.repository
    name: "${{ matrix.reviewer_label || matrix.reviewer }}"
    runs-on: ubuntu-latest
    timeout-minutes: 12
    permissions:
      contents: read
      pull-requests: read
    strategy:
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v6
      - uses: misty-step/cerberus@v2.22.1
        with:
          perspective: ${{ matrix.perspective }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          post-comment: never
          timeout: "600"
          context: |
            bibliomnomnom is a private-first book tracking + note-taking app.
            Stack: Next.js App Router, React, TypeScript, Tailwind, Convex (data), Clerk (auth), Stripe (billing), Vercel (deploy).
            Design policy: deep modules, minimal interfaces, avoid leaking lower-level details.

  verdict:
    name: Council Verdict
    needs: review
    if: always() && needs.review.result != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: misty-step/cerberus/verdict@v2.22.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
