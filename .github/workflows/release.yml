name: Release

on:
  push:
    branches: ["master"]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: ${{ github.sha }}

      # Landfall: semantic-release + LLM synthesis + release body update
      # https://github.com/misty-step/landfall
      - name: Run Landfall
        id: landfall
        uses: misty-step/landfall@v1.17.2
        with:
          github-token: ${{ secrets.GH_RELEASE_TOKEN }}
          llm-api-key: ${{ secrets.OPENROUTER_API_KEY }}
          audience: end-user
          product-description: "A private-first book tracking app for voracious readers."
          voice-guide: "Warm, welcoming, non-technical. Speak to 'you'. No implementation details. 2-3 short paragraphs. No headings or bullets."
          notes-output-file: content/releases/{version}/notes.md

      - name: Setup Bun
        if: steps.landfall.outputs.released == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.17"

      - name: Use Node
        if: steps.landfall.outputs.released == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        if: steps.landfall.outputs.released == 'true'
        run: bun install --frozen-lockfile

      - name: Generate release content for /releases
        if: steps.landfall.outputs.released == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: bun run generate:releases

      - name: Commit and push release content
        if: steps.landfall.outputs.released == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
          TARGET_BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Ensure we have the semantic-release commit (and tags) before committing content.
          git fetch --tags --force 2>/dev/null || true
          git pull origin "${TARGET_BRANCH}"

          if git diff --quiet content/releases/; then
            echo "::notice::No release content changes to commit."
            exit 0
          fi

          release_tag="${{ steps.landfall.outputs['release-tag'] }}"
          git add content/releases/
          git commit -m "chore(releases): generate content for ${release_tag} [skip ci]"
          git push origin "HEAD:${TARGET_BRANCH}"
